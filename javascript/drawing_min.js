/* 
   Canvas-based function drawing script
   (c) David Lippman, part of www.imathas.com
   GNU 2 Licensed - see license in IMathAS distribution
   */
function clearcanvas(n){lines[n].length=0,dots[n].length=0,odots[n].length=0,tplines[n].length=0,tptypes[n].length=0,ineqlines[n].length=0,ineqtypes[n].length=0,curTarget=n,drawTarget(),curTarget=null,curLine=null,dragObj=null}function addTarget(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y){var p=null,k="none",w=document.getElementById(t),b;w.style.userSelect=k,w.style.webkitUserSelect=k,w.style.MozUserSelect=k,b=getPosition(w),targets[n]={el:w,left:b.x,top:b.y,width:w.offsetWidth,height:w.offsetHeight,xmin:u,xmax:f,ymin:e,ymax:o,imgborder:s,imgwidth:h,imgheight:c,mode:l,dotline:a},typeof y=="string"&&y.indexOf(":")!=-1?(y=y.split(":"),targets[n].snaptogridx=1*y[0],targets[n].snaptogridy=1*y[1]):(targets[n].snaptogridx=y,targets[n].snaptogridy=y),targets[n].pixperx=(h-2*s)/(f-u),targets[n].pixpery=(c-2*s)/(o-e),targetOuts[n]=document.getElementById(r),lines[n]==p&&(lines[n]=[]),dots[n]==p&&(dots[n]=[]),odots[n]==p&&(odots[n]=[]),tplines[n]==p&&(tplines[n]=[]),tptypes[n]==p&&(tptypes[n]=[]),ineqlines[n]==p&&(ineqlines[n]=[]),ineqtypes[n]==p&&(ineqtypes[n]=[]),drawstyle[n]=l>=5?1:0,drawlocky[n]=v,imgs[n]=new Image,imgs[n].onload=function(){var t=curTarget;curTarget=n,drawTarget(),curTarget=t},imgs[n].src=i}function settool(n,t,i){for(var f=document.getElementById("drawtools"+t),u=f.getElementsByTagName("span"),r=0;r<u.length;r++)u[r].className="";for(u=f.getElementsByTagName("img"),r=0;r<u.length;r++)u[r].className="";n.className="sel",setDrawMode(t,i)}function setDrawMode(n,t){targets[n].mode=t}function setDotLine(n,t){targets[n].dotline=t}function drawTarget(n,t){var e=null,ot="rgb(0,0,255)",d=!0,r,rt,c,ut,ft,k,ht,s,b,p,f,u,g,l,v,w,a,y,h,o,i;try{r=targets[curTarget].el.getContext("2d")}catch(gt){nocanvaswarning||(nocanvaswarning=d,alert("Your browser does not support drawing answer entry.  Please try again using Internet Explorer 6+ (Windows), FireFox 1.5+ (Win/Mac), Safari 1.3+ (Mac), Opera 9+ (Win/Mac), or Camino (Mac)"))}for(r.fillStyle=ot,r.lineWidth=2,r.strokeStyle=ot,r.clearRect(0,0,targets[curTarget].imgwidth,targets[curTarget].imgheight),r.drawImage(imgs[curTarget],0,0),r.beginPath(),i=0;i<ineqlines[curTarget].length;i++){rt=i%3,r.strokeStyle=ineqcolors[rt],r.fillStyle=ineqcolors[rt];var s=e,u=e,nt=e,f=e,st=e;if(ineqlines[curTarget][i].length==3?(u=ineqlines[curTarget][i][1][0],f=ineqlines[curTarget][i][1][1],nt=ineqlines[curTarget][i][2][0],st=ineqlines[curTarget][i][2][1]):ineqlines[curTarget][i].length==2?(u=ineqlines[curTarget][i][1][0],f=ineqlines[curTarget][i][1][1],nt=n,st=t):curIneqcurve==i&&n!=e&&ineqlines[curTarget][i].length==1&&(u=n,f=t),nt!=e){if(r.save(),r.fillStyle=ineqacolors[rt],r.beginPath(),u!=ineqlines[curTarget][i][0][0]&&(s=(f-ineqlines[curTarget][i][0][1])/(u-ineqlines[curTarget][i][0][0])),Math.abs(u-ineqlines[curTarget][i][0][0])<1||Math.abs(s)>100)r.moveTo(ineqlines[curTarget][i][0][0],0),r.lineTo(ineqlines[curTarget][i][0][0],targets[curTarget].imgheight),nt>u?(r.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),r.lineTo(targets[curTarget].imgwidth,0),r.closePath()):(r.lineTo(0,targets[curTarget].imgheight),r.lineTo(0,0),r.closePath());else{var yt=s*(nt-u)+f,b=ineqlines[curTarget][i][0][1]-s*ineqlines[curTarget][i][0][0],p=ineqlines[curTarget][i][0][1]+s*(targets[curTarget].imgwidth-ineqlines[curTarget][i][0][0]);r.moveTo(0,b),r.lineTo(targets[curTarget].imgwidth,p),st>yt?(r.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),r.lineTo(0,targets[curTarget].imgheight),r.closePath()):(r.lineTo(targets[curTarget].imgwidth,0),r.lineTo(0,0),r.closePath())}r.fill(),r.restore()}for(r.beginPath(),u!=e&&(u!=ineqlines[curTarget][i][0][0]&&(s=(f-ineqlines[curTarget][i][0][1])/(u-ineqlines[curTarget][i][0][0])),Math.abs(u-ineqlines[curTarget][i][0][0])<1||Math.abs(s)>100?ineqtypes[curTarget][i]==10.2?dragObj!=e&&dragObj.mode>=10&&dragObj.mode<11&&dragObj.num==i&&dragObj.subnum==0?(r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],ineqlines[curTarget][i][1][0],targets[curTarget].imgheight),r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],ineqlines[curTarget][i][1][0],0)):(r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],ineqlines[curTarget][i][0][0],targets[curTarget].imgheight),r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],ineqlines[curTarget][i][0][0],0)):(r.moveTo(ineqlines[curTarget][i][0][0],0),r.lineTo(ineqlines[curTarget][i][0][0],targets[curTarget].imgheight),r.stroke()):(b=ineqlines[curTarget][i][0][1]-s*ineqlines[curTarget][i][0][0],p=ineqlines[curTarget][i][0][1]+s*(targets[curTarget].imgwidth-ineqlines[curTarget][i][0][0]),ineqtypes[curTarget][i]==10.2?dragObj!=e&&dragObj.mode>=10&&dragObj.mode<11&&dragObj.num==i&&dragObj.subnum==0?(r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],targets[curTarget].imgwidth,p),r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],0,b)):(r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],targets[curTarget].imgwidth,p),r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],0,b)):(r.moveTo(0,b),r.lineTo(targets[curTarget].imgwidth,p),r.stroke()))),r.beginPath(),o=0;o<ineqlines[curTarget][i].length;o++)o==2?(r.arc(ineqlines[curTarget][i][o][0],ineqlines[curTarget][i][o][1],4,0,Math.PI*2,d),r.fill()):r.fillRect(ineqlines[curTarget][i][o][0]-3,ineqlines[curTarget][i][o][1]-3,6,6);ineqlines[curTarget][i].length==1&&u!=e&&r.fillRect(u-3,f-3,6,6),r.beginPath()}for(r.fillStyle=ot,r.lineWidth=drawlocky[curTarget]==1?4:2,r.strokeStyle=ot,i=0;i<tplines[curTarget].length;i++){if(tptypes[curTarget][i]>=5&&tptypes[curTarget][i]<6){var s=e,u=e,f=e,c,tt;if(tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=e&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=e)if(tptypes[curTarget][i]==5.3||tptypes[curTarget][i]==5.4)r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),r.lineTo(u,f),tptypes[curTarget][i]==5.4&&(c=[u-tplines[curTarget][i][0][0],f-tplines[curTarget][i][0][1]],ut=Math.sqrt(c[0]*c[0]+c[1]*c[1]),ut>.0001&&(c=[c[0]/ut,c[1]/ut],tt=[-c[1],c[0]],r.moveTo(u-15*c[0]-4*tt[0],f-15*c[1]-5*tt[1]),r.lineTo(u,f),r.moveTo(u-15*c[0]+4*tt[0],f-15*c[1]+5*tt[1]),r.lineTo(u,f)));else if(u!=tplines[curTarget][i][0][0]&&(s=(f-tplines[curTarget][i][0][1])/(u-tplines[curTarget][i][0][0])),Math.abs(u-tplines[curTarget][i][0][0])<1||Math.abs(s)>100)tptypes[curTarget][i]==5.2?(r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),f>tplines[curTarget][i][0][1]?r.lineTo(tplines[curTarget][i][0][0],targets[curTarget].imgheight):r.lineTo(tplines[curTarget][i][0][0],0)):(r.moveTo(tplines[curTarget][i][0][0],0),r.lineTo(tplines[curTarget][i][0][0],targets[curTarget].imgheight));else{var b=tplines[curTarget][i][0][1]-s*tplines[curTarget][i][0][0],p=tplines[curTarget][i][0][1]+s*(targets[curTarget].imgwidth-tplines[curTarget][i][0][0]),b=tplines[curTarget][i][0][1]-s*tplines[curTarget][i][0][0],p=tplines[curTarget][i][0][1]+s*(targets[curTarget].imgwidth-tplines[curTarget][i][0][0]);tptypes[curTarget][i]==5.2?(r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),u>tplines[curTarget][i][0][0]?r.lineTo(targets[curTarget].imgwidth,p):r.lineTo(0,b)):(r.moveTo(0,b),r.lineTo(targets[curTarget].imgwidth,p))}}else if(tptypes[curTarget][i]==6){if(f=e,u=e,tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=e&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=e&&u!=tplines[curTarget][i][0][0])if(f==tplines[curTarget][i][0][1])r.moveTo(0,f),r.lineTo(targets[curTarget].imgwidth,f);else{if(k=(f-tplines[curTarget][i][0][1])/((u-tplines[curTarget][i][0][0])*(u-tplines[curTarget][i][0][0])),f>tplines[curTarget][i][0][1])var it=Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][i][0][1])/k)+tplines[curTarget][i][0][0],lt=-1*Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][i][0][1])/k)+tplines[curTarget][i][0][0],vt=tplines[curTarget][i][0][1]-(targets[curTarget].imgheight-tplines[curTarget][i][0][1]),et=targets[curTarget].imgheight;else var it=Math.sqrt((0-tplines[curTarget][i][0][1])/k)+tplines[curTarget][i][0][0],lt=-1*Math.sqrt((0-tplines[curTarget][i][0][1])/k)+tplines[curTarget][i][0][0],vt=2*tplines[curTarget][i][0][1],et=0;var at=it+2/3*(tplines[curTarget][i][0][0]-it),ct=et+2/3*(vt-et),wt=at+(lt-it)/3,pt=ct;r.moveTo(it,et),r.bezierCurveTo(at,ct,wt,pt,lt,et)}}else if(tptypes[curTarget][i]==6.5){if(f=e,u=e,tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=e&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=e&&u!=tplines[curTarget][i][0][0])if(f==tplines[curTarget][i][0][1])r.moveTo(tplines[curTarget][i][0][0],f),u>tplines[curTarget][i][0][0]?r.lineTo(targets[curTarget].imgwidth,f):r.lineTo(0,f);else{ft=u<tplines[curTarget][i][0][0]?-1:1,k=(f-tplines[curTarget][i][0][1])/Math.sqrt(ft*(u-tplines[curTarget][i][0][0])),r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),l=tplines[curTarget][i][0][0],g=tplines[curTarget][i][0][1];do l+=ft*3,r.lineTo(l,k*Math.sqrt(ft*(l-tplines[curTarget][i][0][0]))+tplines[curTarget][i][0][1]);while(l>0&&l<targets[curTarget].imgwidth&&g>0&&g<targets[curTarget].imgheight)}}else if(tptypes[curTarget][i]==7)tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=e&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=e&&(u!=tplines[curTarget][i][0][0]||f!=tplines[curTarget][i][0][1])&&(ht=Math.sqrt((u-tplines[curTarget][i][0][0])*(u-tplines[curTarget][i][0][0])+(f-tplines[curTarget][i][0][1])*(f-tplines[curTarget][i][0][1])),r.arc(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1],ht,0,2*Math.PI,d));else if(tptypes[curTarget][i]==8){var s=e,u=e,f=e;tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=e&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=e&&(u!=tplines[curTarget][i][0][0]&&(s=(f-tplines[curTarget][i][0][1])/(u-tplines[curTarget][i][0][0]),u<tplines[curTarget][i][0][0]&&(s*=-1)),Math.abs(u-tplines[curTarget][i][0][0])<1||Math.abs(s)>100?(r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),f>tplines[curTarget][i][0][1]?r.lineTo(tplines[curTarget][i][0][0],targets[curTarget].imgheight):r.lineTo(tplines[curTarget][i][0][0],0)):(b=tplines[curTarget][i][0][1]+s*tplines[curTarget][i][0][0],p=tplines[curTarget][i][0][1]+s*(targets[curTarget].imgwidth-tplines[curTarget][i][0][0]),r.moveTo(0,b),r.lineTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),r.lineTo(targets[curTarget].imgwidth,p)))}else if((tptypes[curTarget][i]==9||tptypes[curTarget][i]==9.1)&&(f=e,u=e,tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=e&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=e&&u!=tplines[curTarget][i][0][0]))if(f==tplines[curTarget][i][0][1])r.moveTo(0,f),r.lineTo(targets[curTarget].imgwidth,f);else{if(tptypes[curTarget][i]==9)var dt=Math.abs(f-tplines[curTarget][i][0][1])/-2,kt=(f+tplines[curTarget][i][0][1])/2,k=Math.PI/Math.abs(u-tplines[curTarget][i][0][0]),bt=f<tplines[curTarget][i][0][1]?u:tplines[curTarget][i][0][0];else if(tptypes[curTarget][i]==9.1)var dt=-1*Math.abs(f-tplines[curTarget][i][0][1]),kt=tplines[curTarget][i][0][1],k=.5*Math.PI/Math.abs(u-tplines[curTarget][i][0][0]),bt=f<tplines[curTarget][i][0][1]?u:u+2*Math.abs(u-tplines[curTarget][i][0][0]);for(g=0,l=0;l<targets[curTarget].imgwidth+4;l+=3)g=dt*Math.cos(k*(l-bt))+kt,l==0?r.moveTo(l,g):r.lineTo(l,g)}for(r.stroke(),o=0;o<tplines[curTarget][i].length;o++)r.fillRect(tplines[curTarget][i][o][0]-3,tplines[curTarget][i][o][1]-3,6,6);tplines[curTarget][i].length==1&&n!=e&&curTPcurve==i&&r.fillRect(n-3,t-3,6,6),r.beginPath()}for(i=0;i<lines[curTarget].length;i++){for(o=0;o<lines[curTarget][i].length;o++)o==0?(r.moveTo(lines[curTarget][i][o][0],lines[curTarget][i][o][1]),v=lines[curTarget][i][o][0],w=lines[curTarget][i][o][1]):(r.lineTo(lines[curTarget][i][o][0],lines[curTarget][i][o][1]),a=lines[curTarget][i][o][0],y=lines[curTarget][i][o][1]);i==curLine&&n!=e&&(r.lineTo(n,t),a=n,y=t),h=targets[curTarget].imgwidth*.02,drawlocky[curTarget]==1&&a>targets[curTarget].imgwidth*.98?(r.moveTo(a,y),r.lineTo(a-h,y+h),r.moveTo(a,y),r.lineTo(a-h,y-h)):drawlocky[curTarget]==1&&v>targets[curTarget].imgwidth*.98&&(r.moveTo(v,w),r.lineTo(v-h,w+h),r.moveTo(v,w),r.lineTo(v-h,w-h)),drawlocky[curTarget]==1&&a<targets[curTarget].imgwidth*.02?(r.moveTo(a,y),r.lineTo(a+h,y+h),r.moveTo(a,y),r.lineTo(a+h,y-h)):drawlocky[curTarget]==1&&v<targets[curTarget].imgwidth*.02&&(r.moveTo(v,w),r.lineTo(v+h,w+h),r.moveTo(v,w),r.lineTo(v+h,w-h))}for(r.stroke(),r.beginPath(),i=0;i<dots[curTarget].length;i++)r.moveTo(dots[curTarget][i][0]+5,dots[curTarget][i][1]),r.arc(dots[curTarget][i][0],dots[curTarget][i][1],5,0,Math.PI*2,d);if(r.fill(),targets[curTarget].dotline==d){for(r.beginPath(),i=0;i<lines[curTarget].length;i++)for(o=0;o<lines[curTarget][i].length;o++)(o==0||Math.pow(lines[curTarget][i][o][0]-lines[curTarget][i][0][0],2)+Math.pow(lines[curTarget][i][o][1]-lines[curTarget][i][0][1],2)>25)&&(r.moveTo(lines[curTarget][i][o][0]+5,lines[curTarget][i][o][1]),r.arc(lines[curTarget][i][o][0],lines[curTarget][i][o][1],5,0,Math.PI*2,d));r.fill()}for(r.fillStyle="rgb(255,255,255)",r.beginPath(),i=0;i<odots[curTarget].length;i++)r.moveTo(odots[curTarget][i][0]+5,odots[curTarget][i][1]),r.arc(odots[curTarget][i][0],odots[curTarget][i][1],4,0,Math.PI*2,d);for(r.fill(),r.lineWidth=2,r.beginPath(),i=0;i<odots[curTarget].length;i++)r.moveTo(odots[curTarget][i][0]+5,odots[curTarget][i][1]),r.arc(odots[curTarget][i][0],odots[curTarget][i][1],4,0,Math.PI*2,d);r.stroke(),encodeDraw()}function encodeDraw(){var u=";;",t=",";for(var i="",r,n=0;n<lines[curTarget].length;n++)for(n!=0&&(i+=";"),r=0;r<lines[curTarget][n].length;r++)r!=0&&(i+=t),i+="("+lines[curTarget][n][r][0]+t+lines[curTarget][n][r][1]+")";for(i+=u,n=0;n<dots[curTarget].length;n++)n!=0&&(i+=t),i+="("+dots[curTarget][n][0]+t+dots[curTarget][n][1]+")";for(i+=u,n=0;n<odots[curTarget].length;n++)n!=0&&(i+=t),i+="("+odots[curTarget][n][0]+t+odots[curTarget][n][1]+")";for(i+=u,n=0;n<tplines[curTarget].length;n++)n!=0&&(i+=t),tplines[curTarget][n].length>1&&(i+="("+tptypes[curTarget][n]+t+tplines[curTarget][n][0][0]+t+tplines[curTarget][n][0][1]+t+tplines[curTarget][n][1][0]+t+tplines[curTarget][n][1][1]+")");for(i+=u,n=0;n<ineqlines[curTarget].length;n++)n!=0&&(i+=t),ineqlines[curTarget][n].length>2&&(i+="("+ineqtypes[curTarget][n]+t+ineqlines[curTarget][n][0][0]+t+ineqlines[curTarget][n][0][1]+t+ineqlines[curTarget][n][1][0]+t+ineqlines[curTarget][n][1][1]+t+ineqlines[curTarget][n][2][0]+t+ineqlines[curTarget][n][2][1]+")");targetOuts[curTarget].value=i}function drawMouseDown(n){var h="/img/pen.cur), default",o="move",c="/img/pendown.cur), default",s="url(",u=null,e,f,r,t;if(hasTouch&&n.touches.length>1)return!0;if(e=mouseCoords(n),curTarget==u)for(i in targets)if(f=getPosition(targets[i].el),f.x<e.x&&f.x+targets[i].width>e.x&&f.y<e.y&&f.y+targets[i].height>e.y){curTarget=i;break}curTarget!=u&&(navigator.userAgent.match(/Android/i)&&n.preventDefault(),mouseisdown=!0,f=getPosition(targets[curTarget].el),r={x:e.x-f.x,y:e.y-f.y},r.x>-1&&r.x<targets[curTarget].width&&r.y>-1&&r.y<targets[curTarget].height?(targets[curTarget].snaptogridx>0&&(r=snaptogrid(r,curTarget)),drawlocky[curTarget]==1&&(r.y=targets[curTarget].imgheight/2),t=findnearpoint(curTarget,r),t==u?(targets[curTarget].el.style.cursor=s+imasroot+c,targets[curTarget].mode==1?(dots[curTarget].push([r.x,r.y]),dragObj={mode:1,num:dots[curTarget].length-1}):targets[curTarget].mode==2?(odots[curTarget].push([r.x,r.y]),dragObj={mode:2,num:odots[curTarget].length-1}):targets[curTarget].mode==0?curLine==u?(lines[curTarget].push([[r.x,r.y]]),curLine=lines[curTarget].length-1):lines[curTarget][curLine].push([r.x,r.y]):targets[curTarget].mode==.5?curLine==u?(lines[curTarget].push([[r.x,r.y]]),curLine=lines[curTarget].length-1):(lines[curTarget][curLine].push([r.x,r.y]),curLine=u,dragObj=u):targets[curTarget].mode>=5&&targets[curTarget].mode<10?curTPcurve==u?(tplines[curTarget].push([[r.x,r.y]]),curTPcurve=tplines[curTarget].length-1,tptypes[curTarget][curTPcurve]=targets[curTarget].mode,mouseisdown=!1):(tplines[curTarget][curTPcurve].push([r.x,r.y]),tplines[curTarget][curTPcurve].length==2&&(dragObj={mode:targets[curTarget].mode,num:curTPcurve,subnum:1},curTPcurve=u)):targets[curTarget].mode>=10&&targets[curTarget].mode<11&&(curIneqcurve==u?(ineqlines[curTarget].push([[r.x,r.y]]),curIneqcurve=ineqlines[curTarget].length-1,ineqtypes[curTarget][curIneqcurve]=targets[curTarget].mode,mouseisdown=!1):(ineqlines[curTarget][curIneqcurve].push([r.x,r.y]),ineqlines[curTarget][curIneqcurve].length==3&&(dragObj={mode:targets[curTarget].mode,num:curIneqcurve,subnum:1},curIneqcurve=u)))):t[0]==0||t[0]==.5?curLine==u?(targets[curTarget].el.style.cursor=o,dragObj={mode:targets[curTarget].mode,num:t[1],subnum:t[2]},oldpointpos=lines[curTarget][t[1]][t[2]],t[2]==lines[curTarget][t[1]].length-1&&targets[curTarget].mode==0?curLine=t[1]:t[2]==0&&targets[curTarget].mode==0&&(curLine=t[1],lines[curTarget][curLine].reverse(),dragObj.subnum=lines[curTarget][curLine].length-1)):t[1]==curLine&&t[2]==lines[curTarget][t[1]].length-1?(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),curLine=u):(targets[curTarget].el.style.cursor=s+imasroot+c,lines[curTarget][curLine].push([r.x,r.y])):t[0]==1?(targets[curTarget].el.style.cursor=o,dragObj={mode:1,num:t[1]}):t[0]==2?(targets[curTarget].el.style.cursor=o,dragObj={mode:2,num:t[1]}):t[0]>=5&&t[0]<10?(targets[curTarget].el.style.cursor=o,dragObj={mode:t[0],num:t[1],subnum:t[2]},oldpointpos=tplines[curTarget][t[1]][t[2]]):t[0]>=10&&t[0]<11&&(targets[curTarget].el.style.cursor=o,dragObj={mode:t[0],num:t[1],subnum:t[2]},oldpointpos=ineqlines[curTarget][t[1]][t[2]]),drawTarget()):(curLine!=u&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),targets[curTarget].el.style.cursor=s+imasroot+h),curTPcurve!=u&&(tplines[curTarget][curTPcurve].length<2&&tplines[curTarget].splice(curTPcurve,1),targets[curTarget].el.style.cursor=s+imasroot+h),curIneqcurve!=u&&(ineqlines[curTarget][curIneqcurve].length<3&&ineqlines[curTarget].splice(curIneqcurve,1),targets[curTarget].el.style.cursor=s+imasroot+h),curLine=u,curTPcurve=u,curIneqcurve=u,dragObj=u,drawTarget(),curTarget=u))}function findnearpoint(n,t){var u,i,r,f;if(hasTouch?(u=Math.max(15*window.innerWidth/screen.width,15),u*=u):u=25,drawstyle[n]==0){if(targets[n].mode==0||targets[n].mode==.5){for(i=0;i<lines[n].length;i++)for(r=lines[n][i].length-1;r>=0;r--)if(f=Math.pow(lines[n][i][r][0]-t.x,2)+Math.pow(lines[n][i][r][1]-t.y,2),f<u)return[targets[n].mode,i,r]}else if(targets[n].mode==1){for(i=0;i<dots[n].length;i++)if(Math.pow(dots[n][i][0]-t.x,2)+Math.pow(dots[n][i][1]-t.y,2)<u)return[1,i]}else if(targets[n].mode==2){for(i=0;i<odots[n].length;i++)if(Math.pow(odots[n][i][0]-t.x,2)+Math.pow(odots[n][i][1]-t.y,2)<u)return[2,i]}else if(targets[n].mode>=5&&targets[n].mode<10){for(i=0;i<tplines[n].length;i++)if(tptypes[n][i]==targets[n].mode)for(r=tplines[n][i].length-1;r>=0;r--)if(f=Math.pow(tplines[n][i][r][0]-t.x,2)+Math.pow(tplines[n][i][r][1]-t.y,2),f<u)return[tptypes[n][i],i,r]}else if(targets[n].mode>=10&&targets[n].mode<11)for(i=0;i<ineqlines[n].length;i++)for(r=ineqlines[n][i].length-1;r>=0;r--)if(f=Math.pow(ineqlines[n][i][r][0]-t.x,2)+Math.pow(ineqlines[n][i][r][1]-t.y,2),f<u)return[ineqtypes[n][i],i,r]}else if(targets[n].mode==1){for(i=0;i<dots[n].length;i++)if(Math.pow(dots[n][i][0]-t.x,2)+Math.pow(dots[n][i][1]-t.y,2)<u)return[1,i]}else if(targets[n].mode==2){for(i=0;i<odots[n].length;i++)if(Math.pow(odots[n][i][0]-t.x,2)+Math.pow(odots[n][i][1]-t.y,2)<u)return[2,i]}else if(targets[n].mode>=5&&targets[n].mode<10){for(i=0;i<tplines[n].length;i++)for(r=tplines[n][i].length-1;r>=0;r--)if(tptypes[n][i]==targets[n].mode&&(f=Math.pow(tplines[n][i][r][0]-t.x,2)+Math.pow(tplines[n][i][r][1]-t.y,2),f<u))return[tptypes[n][i],i,r]}else if(targets[n].mode>=10&&targets[n].mode<11)for(i=0;i<ineqlines[n].length;i++)for(r=ineqlines[n][i].length-1;r>=0;r--)if(f=Math.pow(ineqlines[n][i][r][0]-t.x,2)+Math.pow(ineqlines[n][i][r][1]-t.y,2),f<u)return[ineqtypes[n][i],i,r];return null}function drawMouseUp(n){var t=null,r=mouseCoords(n),i,u;mouseisdown=!1,curTarget!=t&&(u=getPosition(targets[curTarget].el),i={x:r.x-u.x,y:r.y-u.y},targets[curTarget].snaptogridx>0&&(i=snaptogrid(i,curTarget)),lastdrawmouseup!=t&&r.x==lastdrawmouseup.x&&r.y==lastdrawmouseup.y&&curLine!=t&&dragObj==t&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),curLine=t,dragObj=t,drawTarget()),curLine!=t&&dragObj==t&&targets[curTarget].mode==.5&&lines[curTarget][curLine].length>1&&(curLine=t,dragobj=t,drawTarget()),curTPcurve!=t&&tplines[curTarget][curTPcurve].length==1&&(didMultiTouch?(tplines[curTarget].splice(curTPcurve,1),curTPcurve=t,drawTarget()):findnearpoint(curTarget,i)==t&&(tplines[curTarget][curTPcurve].push([i.x,i.y]),curTPcurve=t,drawTarget())),curIneqcurve!=t&&ineqlines[curTarget][curIneqcurve].length==1&&(didMultiTouch?(ineqlines[curTarget].splice(curIneqcurve,1),curIneqcurve=t,drawTarget()):findnearpoint(curTarget,i)==t&&(ineqlines[curTarget][curIneqcurve].push([i.x,i.y]),drawTarget())),targets[curTarget].el.style.cursor=curLine==t&&curTPcurve==t?"move":"url("+imasroot+"/img/pen.cur), default",n.preventDefault()),lastdrawmouseup=r,curTarget!=t&&dragObj!=t&&(u=getPosition(targets[curTarget].el),i.x>-1&&i.x<targets[curTarget].width&&i.y>-1&&i.y<targets[curTarget].height?dragObj=t:(drawlocky[curTarget]==1&&(i.y=targets[curTarget].imgheight/2),dragObj.mode==1?dots[curTarget].splice(dragObj.num,1):dragObj.mode==2?odots[curTarget].splice(dragObj.num,1):dragObj.mode==.5?lines[curTarget].splice(dragObj.num,1):dragObj.mode==0?lines[curTarget][dragObj.num][dragObj.subnum]=oldpointpos:dragObj.mode>=5&&dragObj.mode<10?(tplines[curTarget].splice(dragObj.num,1),curTPcurve=t):dragObj.mode>=10&&dragObj.mode<11&&(ineqlines[curTarget].splice(dragObj.num,1),curIneqcurve=t),dragObj=t,drawTarget())),didMultiTouch=!1}function drawMouseMove(n){var c="move",l="/img/pen.cur), default",u=null,r=u,o=mouseCoords(n),f,t,e,s,h;if(curTarget==u)for(i in targets)if(f=getPosition(targets[i].el),f.x<o.x&&f.x+targets[i].width>o.x&&f.y<o.y&&f.y+targets[i].height>o.y){r=i;break}if(r!=u&&(f=getPosition(targets[r].el),t={x:o.x-f.x,y:o.y-f.y},targets[r].snaptogridx>0&&(t=snaptogrid(t,r)),drawlocky[r]==1&&(t.y=targets[r].imgheight/2),t.x>-1&&t.x<targets[r].width&&t.y>-1&&t.y<targets[r].height&&dragObj==u&&curLine==u&&(h=findnearpoint(r,t),targets[r].el.style.cursor=h==u?"url("+imasroot+l:c)),curTarget!=u){if(hasTouch&&n.touches.length>1)return didMultiTouch=!0,!0;if(n.preventDefault(),f=getPosition(targets[curTarget].el),t={x:o.x-f.x,y:o.y-f.y},targets[curTarget].snaptogridx>0&&(t=snaptogrid(t,curTarget)),drawlocky[curTarget]==1&&(t.y=targets[curTarget].imgheight/2),t.x>-1&&t.x<targets[curTarget].width&&t.y>-1&&t.y<targets[curTarget].height)return dragObj==u?curLine!=u?mouseisdown&&targets[curTarget].mode==0?(e=lines[curTarget][curLine].length-1,s=Math.pow(lines[curTarget][curLine][e][0]-t.x,2)+Math.pow(lines[curTarget][curLine][e][1]-t.y,2),s>25?(lines[curTarget][curLine].push([t.x,t.y]),drawTarget()):drawTarget(t.x,t.y)):mouseisdown&&targets[curTarget].mode==.5?(e=lines[curTarget][curLine].length-1,e==0?(s=Math.pow(lines[curTarget][curLine][e][0]-t.x,2)+Math.pow(lines[curTarget][curLine][e][1]-t.y,2),s>25?(lines[curTarget][curLine].push([t.x,t.y]),drawTarget()):drawTarget(t.x,t.y)):(lines[curTarget][curLine][e]=[t.x,t.y],drawTarget())):drawTarget(t.x,t.y):curTPcurve!=u?mouseisdown?drawTarget():drawTarget(t.x,t.y):curIneqcurve!=u?mouseisdown?drawTarget():drawTarget(t.x,t.y):(h=findnearpoint(curTarget,t),targets[curTarget].el.style.cursor=h==u?"url("+imasroot+l:c):(targets[curTarget].el.style.cursor=c,dragObj.mode==0||dragObj.mode==.5?lines[curTarget][dragObj.num][dragObj.subnum]=[t.x,t.y]:dragObj.mode==1?dots[curTarget][dragObj.num]=[t.x,t.y]:dragObj.mode==2?odots[curTarget][dragObj.num]=[t.x,t.y]:dragObj.mode>=5&&dragObj.mode<10?tplines[curTarget][dragObj.num][dragObj.subnum]=[t.x,t.y]:dragObj.mode>=10&&dragObj.mode<11&&(ineqlines[curTarget][dragObj.num][dragObj.subnum]=[t.x,t.y]),drawTarget()),!1}}function mouseCoords(n){var f,t,u,i,r;return(n=n||window.event,hasTouch)?(f=n.changedTouches[0]||n.touches[0],{x:f.pageX,y:f.pageY}):n.pageX||n.pageY?{x:n.pageX,y:n.pageY}:(t=document.documentElement,u=document.body,t&&(t.scrollTop||t.scrollLeft)?(i=t.scrollLeft,r=t.scrollTop):u?(i=u.scrollLeft,r=u.scrollTop):(i=0,r=0),{x:n.clientX+i,y:n.clientY+r})}function snaptogrid(n,t){var r=n.x-targets[t].imgborder+targets[t].xmin*targets[t].pixperx,i=n.y-targets[t].imgborder-targets[t].ymax*targets[t].pixpery;return r=Math.round(Math.round(r/(targets[t].pixperx*targets[t].snaptogridx))*targets[t].pixperx*targets[t].snaptogridx+targets[t].imgborder-targets[t].xmin*targets[t].pixperx),i=Math.round(Math.round(i/(targets[t].pixpery*targets[t].snaptogridy))*targets[t].pixpery*targets[t].snaptogridy+targets[t].imgborder+targets[t].ymax*targets[t].pixpery),{x:r,y:i}}function getMouseOffset(n,t){var r=getPosition(n),i=mouseCoords(t);return{x:i.x-r.x,y:i.y-r.y}}function getPosition(n){var i=0,t=0;if(n.getBoundingClientRect){var r=n.getBoundingClientRect(),f=Math.max(document.documentElement.scrollTop,document.body.scrollTop),u=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);return{x:r.left+u,y:r.top+f}}while(n.offsetParent)i+=n.offsetLeft,t+=n.offsetTop,n=n.offsetParent;return i+=n.offsetLeft,t+=n.offsetTop,{x:i,y:t}}function initCanvases(n){var t,i;hasTouch="ontouchstart"in document.documentElement,hasTouch?(document.addEventListener("touchstart",drawMouseDown),document.addEventListener("touchmove",drawMouseMove),document.addEventListener("touchend",drawMouseUp)):(document.onmousedown=drawMouseDown,document.onmouseup=drawMouseUp,document.onmousemove=drawMouseMove);try{CanvasRenderingContext2D.prototype.dashedLine=function(n,t,i,r,u){var f=this,o;u==undefined&&(u=10),f.beginPath(),f.moveTo(n,t);var s=i-n,h=r-t,e=Math.sqrt(s*s+h*h)/u,c=s/e,l=h/e;for(e=Math.round(e),o=0;o++<e&&t>0&&t<targets[curTarget].imgheight;)n+=c,t+=l,f[o%2==0?"moveTo":"lineTo"](n,t);f[o%2==0?"moveTo":"lineTo"](i,r),f.stroke(),f.closePath()}}catch(r){}for(t in canvases)if(typeof n=="undefined"||n==t){if(drawla[t]!=null&&drawla[t].length>2){if(lines[canvases[t][0]]=drawla[t][0],dots[canvases[t][0]]=drawla[t][1],odots[canvases[t][0]]=drawla[t][2],drawla[t].length>3&&drawla[t][3].length>0)for(tptypes[canvases[t][0]]=[],tplines[canvases[t][0]]=[],i=0;i<drawla[t][3].length;i++)tptypes[canvases[t][0]][i]=drawla[t][3][i][0],tplines[canvases[t][0]][i]=[drawla[t][3][i].slice(1,3),drawla[t][3][i].slice(3)];if(drawla[t].length>4&&drawla[t][4].length>0)for(ineqtypes[canvases[t][0]]=[],ineqlines[canvases[t][0]]=[],i=0;i<drawla[t][4].length;i++)ineqtypes[canvases[t][0]][i]=drawla[t][4][i][0],ineqlines[canvases[t][0]][i]=[drawla[t][4][i].slice(1,3),drawla[t][4][i].slice(3,5),drawla[t][4][i].slice(5)]}addTarget(canvases[t][0],"canvas"+canvases[t][0],imasroot+"/filter/graph/imgs/"+canvases[t][1],"qn"+canvases[t][0],canvases[t][2],canvases[t][3],canvases[t][4],canvases[t][5],canvases[t][6],canvases[t][7],canvases[t][8],canvases[t][9],canvases[t][10],canvases[t][11],canvases[t][12])}}var mouseisdown=!1,targets=[],imgs=[],targetOuts=[],lines=[],dots=[],odots=[],tplines=[],tptypes=[],ineqlines=[],ineqtypes=[],canvases=[],drawla=[],curLine=null,drawstyle=[],drawlocky=[],curTPcurve=null,curIneqcurve=null,ineqcolors=["rgb(0,0,255)","rgb(255,0,0)","rgb(0,255,0)"],ineqacolors=["rgba(0,0,255,.4)","rgba(255,0,0,.4)","rgba(0,255,0,.4)"],dragObj=null,oldpointpos=null,curTarget=null,nocanvaswarning=!1,hasTouch=!1,didMultiTouch=!1,lastdrawmouseup=null,existing;typeof initstack!="undefined"?initstack.push(initCanvases):typeof window.addEventListener!="undefined"?window.addEventListener("load",initCanvases,!1):typeof document.addEventListener!="undefined"?document.addEventListener("load",initCanvases,!1):typeof window.attachEvent!="undefined"?window.attachEvent("onload",initCanvases):typeof window.onload=="function"?(existing=onload,window.onload=function(){existing(),initCanvases()}):window.onload=initCanvases;
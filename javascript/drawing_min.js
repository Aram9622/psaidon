/* 
   Canvas-based function drawing script
   (c) David Lippman, part of www.imathas.com
   GNU 2 Licensed - see license in IMathAS distribution
   */
var mouseisdown=false,targets=[],imgs=[],targetOuts=[],lines=[],dots=[],odots=[],tplines=[],tptypes=[],ineqlines=[],ineqtypes=[],canvases=[],drawla=[],curLine=null,drawstyle=[],drawlocky=[],curTPcurve=null,curIneqcurve=null,ineqcolors=["rgb(0,0,255)","rgb(255,0,0)","rgb(0,255,0)"],ineqacolors=["rgba(0,0,255,.4)","rgba(255,0,0,.4)","rgba(0,255,0,.4)"],dragObj=null,oldpointpos=null,curTarget=null,nocanvaswarning=false,hasTouch=false,didMultiTouch=false;function clearcanvas(a){lines[a].length=0;dots[a].length=0;odots[a].length=0;tplines[a].length=0;tptypes[a].length=0;ineqlines[a].length=0;ineqtypes[a].length=0;curTarget=a;drawTarget();curTarget=null;curLine=null;dragObj=null}function addTarget(a,m,k,l,p,o,r,q,g,i,h,e,j,n){var b=null,d="none",c=document.getElementById(m);c.style.userSelect=d;c.style.webkitUserSelect=d;c.style.MozUserSelect=d;var f=getPosition(c);targets[a]={el:c,left:f.x,top:f.y,width:c.offsetWidth,height:c.offsetHeight,xmin:p,xmax:o,ymin:r,ymax:q,imgborder:g,imgwidth:i,imgheight:h,mode:e,dotline:j};targetOuts[a]=document.getElementById(l);if(lines[a]==b)lines[a]=[];if(dots[a]==b)dots[a]=[];if(odots[a]==b)odots[a]=[];if(tplines[a]==b)tplines[a]=[];if(tptypes[a]==b)tptypes[a]=[];if(ineqlines[a]==b)ineqlines[a]=[];if(ineqtypes[a]==b)ineqtypes[a]=[];if(e>=5)drawstyle[a]=1;else drawstyle[a]=0;drawlocky[a]=n;imgs[a]=new Image;imgs[a].onload=function(){var b=curTarget;curTarget=a;drawTarget();curTarget=b};imgs[a].src=k}function settool(e,c,f){for(var d=document.getElementById("drawtools"+c),b=d.getElementsByTagName("span"),a=0;a<b.length;a++)b[a].className="";b=d.getElementsByTagName("img");for(var a=0;a<b.length;a++)b[a].className="";e.className="sel";setDrawMode(c,f)}function setDrawMode(a,b){targets[a].mode=b}function setDotLine(a,b){targets[a].dotline=b}function drawTarget(h,o){var f=null,y="rgb(0,0,255)",r=true;try{var b=targets[curTarget].el.getContext("2d")}catch(S){if(!nocanvaswarning){nocanvaswarning=r;alert("Your browser does not support drawing answer entry.  Please try again using Internet Explorer 6+ (Windows), FireFox 1.5+ (Win/Mac), Safari 1.3+ (Mac), Opera 9+ (Win/Mac), or Camino (Mac)")}}b.fillStyle=y;b.lineWidth=2;b.strokeStyle=y;b.clearRect(0,0,targets[curTarget].imgwidth,targets[curTarget].imgheight);b.drawImage(imgs[curTarget],0,0);b.beginPath();for(var a=0;a<ineqlines[curTarget].length;a++){var B=a%3;b.strokeStyle=ineqcolors[B];b.fillStyle=ineqcolors[B];var g=f,c=f,x=f,d=f,D=f;if(ineqlines[curTarget][a].length==3){c=ineqlines[curTarget][a][1][0];d=ineqlines[curTarget][a][1][1];x=ineqlines[curTarget][a][2][0];D=ineqlines[curTarget][a][2][1]}else if(ineqlines[curTarget][a].length==2){c=ineqlines[curTarget][a][1][0];d=ineqlines[curTarget][a][1][1];x=h;D=o}else if(curIneqcurve==a&&h!=f&&ineqlines[curTarget][a].length==1){c=h;d=o}if(x!=f){b.save();b.fillStyle=ineqacolors[B];b.beginPath();if(c!=ineqlines[curTarget][a][0][0])var g=(d-ineqlines[curTarget][a][0][1])/(c-ineqlines[curTarget][a][0][0]);if(Math.abs(c-ineqlines[curTarget][a][0][0])<1||Math.abs(g)>100){b.moveTo(ineqlines[curTarget][a][0][0],0);b.lineTo(ineqlines[curTarget][a][0][0],targets[curTarget].imgheight);if(x>c){b.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight);b.lineTo(targets[curTarget].imgwidth,0);b.closePath()}else{b.lineTo(0,targets[curTarget].imgheight);b.lineTo(0,0);b.closePath()}}else{var Q=g*(x-c)+d,s=ineqlines[curTarget][a][0][1]-g*ineqlines[curTarget][a][0][0],v=ineqlines[curTarget][a][0][1]+g*(targets[curTarget].imgwidth-ineqlines[curTarget][a][0][0]);b.moveTo(0,s);b.lineTo(targets[curTarget].imgwidth,v);if(D>Q){b.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight);b.lineTo(0,targets[curTarget].imgheight);b.closePath()}else{b.lineTo(targets[curTarget].imgwidth,0);b.lineTo(0,0);b.closePath()}}b.fill();b.restore()}b.beginPath();if(c!=f){if(c!=ineqlines[curTarget][a][0][0])var g=(d-ineqlines[curTarget][a][0][1])/(c-ineqlines[curTarget][a][0][0]);if(Math.abs(c-ineqlines[curTarget][a][0][0])<1||Math.abs(g)>100)if(ineqtypes[curTarget][a]==10.2)for(var I=targets[curTarget].imgheight/20,e=0;e<10;e++){b.moveTo(ineqlines[curTarget][a][0][0],I*2*e);b.lineTo(ineqlines[curTarget][a][0][0],I*(2*e+1));b.stroke()}else{b.moveTo(ineqlines[curTarget][a][0][0],0);b.lineTo(ineqlines[curTarget][a][0][0],targets[curTarget].imgheight);b.stroke()}else{var s=ineqlines[curTarget][a][0][1]-g*ineqlines[curTarget][a][0][0],v=ineqlines[curTarget][a][0][1]+g*(targets[curTarget].imgwidth-ineqlines[curTarget][a][0][0]);if(ineqtypes[curTarget][a]==10.2){var q=targets[curTarget].imgwidth/20;if(Math.abs(g)>1){q=q/Math.abs(g);if(q<1)q=1}for(var R=Math.ceil(targets[curTarget].imgwidth/q),e=0;e<R;e++){b.moveTo(q*2*e,s+g*q*2*e);b.lineTo(q*(2*e+1),s+g*q*(2*e+1));b.stroke()}}else{b.moveTo(0,s);b.lineTo(targets[curTarget].imgwidth,v);b.stroke()}}}b.beginPath();for(var e=0;e<ineqlines[curTarget][a].length;e++)if(e==2){b.arc(ineqlines[curTarget][a][e][0],ineqlines[curTarget][a][e][1],4,0,Math.PI*2,r);b.fill()}else b.fillRect(ineqlines[curTarget][a][e][0]-3,ineqlines[curTarget][a][e][1]-3,6,6);b.beginPath()}b.fillStyle=y;if(drawlocky[curTarget]==1)b.lineWidth=4;else b.lineWidth=2;b.strokeStyle=y;for(var a=0;a<tplines[curTarget].length;a++){if(tptypes[curTarget][a]>=5&&tptypes[curTarget][a]<6){var g=f,c=f,d=f,j,w;if(tplines[curTarget][a].length==2){c=tplines[curTarget][a][1][0];d=tplines[curTarget][a][1][1]}else if(curTPcurve==a&&h!=f&&tplines[curTarget][a].length==1){c=h;d=o}if(c!=f)if(tptypes[curTarget][a]==5.3||tptypes[curTarget][a]==5.4){b.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]);b.lineTo(c,d);if(tptypes[curTarget][a]==5.4){var j=[c-tplines[curTarget][a][0][0],d-tplines[curTarget][a][0][1]],E=Math.sqrt(j[0]*j[0]+j[1]*j[1]);if(E>.0001){j=[j[0]/E,j[1]/E];w=[-j[1],j[0]];b.moveTo(c-15*j[0]-4*w[0],d-15*j[1]-5*w[1]);b.lineTo(c,d);b.moveTo(c-15*j[0]+4*w[0],d-15*j[1]+5*w[1]);b.lineTo(c,d)}}}else{if(c!=tplines[curTarget][a][0][0])var g=(d-tplines[curTarget][a][0][1])/(c-tplines[curTarget][a][0][0]);if(Math.abs(c-tplines[curTarget][a][0][0])<1||Math.abs(g)>100)if(tptypes[curTarget][a]==5.2){b.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]);if(d>tplines[curTarget][a][0][1])b.lineTo(tplines[curTarget][a][0][0],targets[curTarget].imgheight);else b.lineTo(tplines[curTarget][a][0][0],0)}else{b.moveTo(tplines[curTarget][a][0][0],0);b.lineTo(tplines[curTarget][a][0][0],targets[curTarget].imgheight)}else{var s=tplines[curTarget][a][0][1]-g*tplines[curTarget][a][0][0],v=tplines[curTarget][a][0][1]+g*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0]),s=tplines[curTarget][a][0][1]-g*tplines[curTarget][a][0][0],v=tplines[curTarget][a][0][1]+g*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0]);if(tptypes[curTarget][a]==5.2){b.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]);if(c>tplines[curTarget][a][0][0])b.lineTo(targets[curTarget].imgwidth,v);else b.lineTo(0,s)}else{b.moveTo(0,s);b.lineTo(targets[curTarget].imgwidth,v)}}}}else if(tptypes[curTarget][a]==6){var d=f,c=f;if(tplines[curTarget][a].length==2){c=tplines[curTarget][a][1][0];d=tplines[curTarget][a][1][1]}else if(curTPcurve==a&&h!=f&&tplines[curTarget][a].length==1){c=h;d=o}if(c!=f&&c!=tplines[curTarget][a][0][0])if(d==tplines[curTarget][a][0][1]){b.moveTo(0,d);b.lineTo(targets[curTarget].imgwidth,d)}else{var t=(d-tplines[curTarget][a][0][1])/((c-tplines[curTarget][a][0][0])*(c-tplines[curTarget][a][0][0]));if(d>tplines[curTarget][a][0][1])var z=Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][a][0][1])/t)+tplines[curTarget][a][0][0],H=-1*Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][a][0][1])/t)+tplines[curTarget][a][0][0],K=tplines[curTarget][a][0][1]-(targets[curTarget].imgheight-tplines[curTarget][a][0][1]),A=targets[curTarget].imgheight;else var z=Math.sqrt((0-tplines[curTarget][a][0][1])/t)+tplines[curTarget][a][0][0],H=-1*Math.sqrt((0-tplines[curTarget][a][0][1])/t)+tplines[curTarget][a][0][0],K=2*tplines[curTarget][a][0][1],A=0;var F=z+2/3*(tplines[curTarget][a][0][0]-z),G=A+2/3*(K-A),L=F+(H-z)/3,M=G;b.moveTo(z,A);b.bezierCurveTo(F,G,L,M,H,A)}}else if(tptypes[curTarget][a]==6.5){var d=f,c=f;if(tplines[curTarget][a].length==2){c=tplines[curTarget][a][1][0];d=tplines[curTarget][a][1][1]}else if(curTPcurve==a&&h!=f&&tplines[curTarget][a].length==1){c=h;d=o}if(c!=f&&c!=tplines[curTarget][a][0][0])if(d==tplines[curTarget][a][0][1]){b.moveTo(tplines[curTarget][a][0][0],d);if(c>tplines[curTarget][a][0][0])b.lineTo(targets[curTarget].imgwidth,d);else b.lineTo(0,d)}else{var C=c<tplines[curTarget][a][0][0]?-1:1,t=(d-tplines[curTarget][a][0][1])/Math.sqrt(C*(c-tplines[curTarget][a][0][0]));b.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]);l=tplines[curTarget][a][0][0];u=tplines[curTarget][a][0][1];do{l+=C*3;b.lineTo(l,t*Math.sqrt(C*(l-tplines[curTarget][a][0][0]))+tplines[curTarget][a][0][1])}while(l>0&&l<targets[curTarget].imgwidth&&u>0&&u<targets[curTarget].imgheight)}}else if(tptypes[curTarget][a]==7){if(tplines[curTarget][a].length==2){c=tplines[curTarget][a][1][0];d=tplines[curTarget][a][1][1]}else if(curTPcurve==a&&h!=f&&tplines[curTarget][a].length==1){c=h;d=o}if(c!=f&&(c!=tplines[curTarget][a][0][0]||d!=tplines[curTarget][a][0][1])){var P=Math.sqrt((c-tplines[curTarget][a][0][0])*(c-tplines[curTarget][a][0][0])+(d-tplines[curTarget][a][0][1])*(d-tplines[curTarget][a][0][1]));b.arc(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1],P,0,2*Math.PI,r)}}else if(tptypes[curTarget][a]==8){var g=f,c=f,d=f;if(tplines[curTarget][a].length==2){c=tplines[curTarget][a][1][0];d=tplines[curTarget][a][1][1]}else if(curTPcurve==a&&h!=f&&tplines[curTarget][a].length==1){c=h;d=o}if(c!=f){if(c!=tplines[curTarget][a][0][0]){var g=(d-tplines[curTarget][a][0][1])/(c-tplines[curTarget][a][0][0]);if(c<tplines[curTarget][a][0][0])g*=-1}if(Math.abs(c-tplines[curTarget][a][0][0])<1||Math.abs(g)>100){b.moveTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]);if(d>tplines[curTarget][a][0][1])b.lineTo(tplines[curTarget][a][0][0],targets[curTarget].imgheight);else b.lineTo(tplines[curTarget][a][0][0],0)}else{var s=tplines[curTarget][a][0][1]+g*tplines[curTarget][a][0][0],v=tplines[curTarget][a][0][1]+g*(targets[curTarget].imgwidth-tplines[curTarget][a][0][0]);b.moveTo(0,s);b.lineTo(tplines[curTarget][a][0][0],tplines[curTarget][a][0][1]);b.lineTo(targets[curTarget].imgwidth,v)}}}else if(tptypes[curTarget][a]==9||tptypes[curTarget][a]==9.1){var d=f,c=f;if(tplines[curTarget][a].length==2){c=tplines[curTarget][a][1][0];d=tplines[curTarget][a][1][1]}else if(curTPcurve==a&&h!=f&&tplines[curTarget][a].length==1){c=h;d=o}if(c!=f&&c!=tplines[curTarget][a][0][0])if(d==tplines[curTarget][a][0][1]){b.moveTo(0,d);b.lineTo(targets[curTarget].imgwidth,d)}else{if(tptypes[curTarget][a]==9)var N=Math.abs(d-tplines[curTarget][a][0][1])/-2,O=(d+tplines[curTarget][a][0][1])/2,t=Math.PI/Math.abs(c-tplines[curTarget][a][0][0]),J=d<tplines[curTarget][a][0][1]?c:tplines[curTarget][a][0][0];else if(tptypes[curTarget][a]==9.1)var N=-1*Math.abs(d-tplines[curTarget][a][0][1]),O=tplines[curTarget][a][0][1],t=.5*Math.PI/Math.abs(c-tplines[curTarget][a][0][0]),J=d<tplines[curTarget][a][0][1]?c:c+2*Math.abs(c-tplines[curTarget][a][0][0]);for(var u=0,l=0;l<targets[curTarget].imgwidth+4;l+=3){u=N*Math.cos(t*(l-J))+O;if(l==0)b.moveTo(l,u);else b.lineTo(l,u)}}}b.stroke();for(var e=0;e<tplines[curTarget][a].length;e++)b.fillRect(tplines[curTarget][a][e][0]-3,tplines[curTarget][a][e][1]-3,6,6);b.beginPath()}for(var m,p,k,n,a=0;a<lines[curTarget].length;a++){for(var e=0;e<lines[curTarget][a].length;e++)if(e==0){b.moveTo(lines[curTarget][a][e][0],lines[curTarget][a][e][1]);m=lines[curTarget][a][e][0];p=lines[curTarget][a][e][1]}else{b.lineTo(lines[curTarget][a][e][0],lines[curTarget][a][e][1]);k=lines[curTarget][a][e][0];n=lines[curTarget][a][e][1]}if(a==curLine&&h!=f){b.lineTo(h,o);k=h;n=o}var i=targets[curTarget].imgwidth*.02;if(drawlocky[curTarget]==1&&k>targets[curTarget].imgwidth*.98){b.moveTo(k,n);b.lineTo(k-i,n+i);b.moveTo(k,n);b.lineTo(k-i,n-i)}else if(drawlocky[curTarget]==1&&m>targets[curTarget].imgwidth*.98){b.moveTo(m,p);b.lineTo(m-i,p+i);b.moveTo(m,p);b.lineTo(m-i,p-i)}if(drawlocky[curTarget]==1&&k<targets[curTarget].imgwidth*.02){b.moveTo(k,n);b.lineTo(k+i,n+i);b.moveTo(k,n);b.lineTo(k+i,n-i)}else if(drawlocky[curTarget]==1&&m<targets[curTarget].imgwidth*.02){b.moveTo(m,p);b.lineTo(m+i,p+i);b.moveTo(m,p);b.lineTo(m+i,p-i)}}b.stroke();b.beginPath();for(var a=0;a<dots[curTarget].length;a++){b.moveTo(dots[curTarget][a][0]+5,dots[curTarget][a][1]);b.arc(dots[curTarget][a][0],dots[curTarget][a][1],5,0,Math.PI*2,r)}b.fill();if(targets[curTarget].dotline==r){b.beginPath();for(var a=0;a<lines[curTarget].length;a++)for(var e=0;e<lines[curTarget][a].length;e++)if(e==0||Math.pow(lines[curTarget][a][e][0]-lines[curTarget][a][0][0],2)+Math.pow(lines[curTarget][a][e][1]-lines[curTarget][a][0][1],2)>25){b.moveTo(lines[curTarget][a][e][0]+5,lines[curTarget][a][e][1]);b.arc(lines[curTarget][a][e][0],lines[curTarget][a][e][1],5,0,Math.PI*2,r)}b.fill()}b.fillStyle="rgb(255,255,255)";b.beginPath();for(var a=0;a<odots[curTarget].length;a++){b.moveTo(odots[curTarget][a][0]+5,odots[curTarget][a][1]);b.arc(odots[curTarget][a][0],odots[curTarget][a][1],4,0,Math.PI*2,r)}b.fill();b.lineWidth=2;b.beginPath();for(var a=0;a<odots[curTarget].length;a++){b.moveTo(odots[curTarget][a][0]+5,odots[curTarget][a][1]);b.arc(odots[curTarget][a][0],odots[curTarget][a][1],4,0,Math.PI*2,r)}b.stroke();encodeDraw()}function encodeDraw(){var e=";;",b=",";for(var c="",a=0;a<lines[curTarget].length;a++){if(a!=0)c+=";";for(var d=0;d<lines[curTarget][a].length;d++){if(d!=0)c+=b;c+="("+lines[curTarget][a][d][0]+b+lines[curTarget][a][d][1]+")"}}c+=e;for(var a=0;a<dots[curTarget].length;a++){if(a!=0)c+=b;c+="("+dots[curTarget][a][0]+b+dots[curTarget][a][1]+")"}c+=e;for(var a=0;a<odots[curTarget].length;a++){if(a!=0)c+=b;c+="("+odots[curTarget][a][0]+b+odots[curTarget][a][1]+")"}c+=e;for(var a=0;a<tplines[curTarget].length;a++){if(a!=0)c+=b;if(tplines[curTarget][a].length>1)c+="("+tptypes[curTarget][a]+b+tplines[curTarget][a][0][0]+b+tplines[curTarget][a][0][1]+b+tplines[curTarget][a][1][0]+b+tplines[curTarget][a][1][1]+")"}c+=e;for(var a=0;a<ineqlines[curTarget].length;a++){if(a!=0)c+=b;if(ineqlines[curTarget][a].length>2)c+="("+ineqtypes[curTarget][a]+b+ineqlines[curTarget][a][0][0]+b+ineqlines[curTarget][a][0][1]+b+ineqlines[curTarget][a][1][0]+b+ineqlines[curTarget][a][1][1]+b+ineqlines[curTarget][a][2][0]+b+ineqlines[curTarget][a][2][1]+")"}targetOuts[curTarget].value=c}function drawMouseDown(k){var h="/img/pen.cur), default",g="move",j="/img/pendown.cur), default",f="url(",c=null;if(hasTouch&&k.touches.length>1)return true;var d=mouseCoords(k);if(curTarget==c)for(i in targets){var e=getPosition(targets[i].el);if(e.x<d.x&&e.x+targets[i].width>d.x&&e.y<d.y&&e.y+targets[i].height>d.y){curTarget=i;break}}if(curTarget!=c){if(navigator.userAgent.match(/Android/i)){k.preventDefault();}mouseisdown=true;var e=getPosition(targets[curTarget].el),b={x:d.x-e.x,y:d.y-e.y};if(b.x>-1&&b.x<targets[curTarget].width&&b.y>-1&&b.y<targets[curTarget].height){if(drawlocky[curTarget]==1)b.y=targets[curTarget].imgheight/2;var a=findnearpoint(curTarget,b);if(a==c){targets[curTarget].el.style.cursor=f+imasroot+j;if(targets[curTarget].mode==1){dots[curTarget].push([b.x,b.y]);dragObj={mode:1,num:dots[curTarget].length-1}}else if(targets[curTarget].mode==2){odots[curTarget].push([b.x,b.y]);dragObj={mode:2,num:odots[curTarget].length-1}}else if(targets[curTarget].mode==0)if(curLine==c){lines[curTarget].push([[b.x,b.y]]);curLine=lines[curTarget].length-1}else lines[curTarget][curLine].push([b.x,b.y]);else if(targets[curTarget].mode==.5)if(curLine==c){lines[curTarget].push([[b.x,b.y]]);curLine=lines[curTarget].length-1}else{lines[curTarget][curLine].push([b.x,b.y]);curLine=c;dragObj=c}else if(targets[curTarget].mode>=5&&targets[curTarget].mode<10)if(curTPcurve==c){tplines[curTarget].push([[b.x,b.y]]);curTPcurve=tplines[curTarget].length-1;tptypes[curTarget][curTPcurve]=targets[curTarget].mode;mouseisdown=false}else{tplines[curTarget][curTPcurve].push([b.x,b.y]);if(tplines[curTarget][curTPcurve].length==2){dragObj={mode:targets[curTarget].mode,num:curTPcurve,subnum:1};curTPcurve=c}}else if(targets[curTarget].mode>=10&&targets[curTarget].mode<11)if(curIneqcurve==c){ineqlines[curTarget].push([[b.x,b.y]]);curIneqcurve=ineqlines[curTarget].length-1;ineqtypes[curTarget][curIneqcurve]=targets[curTarget].mode;mouseisdown=false}else{ineqlines[curTarget][curIneqcurve].push([b.x,b.y]);if(ineqlines[curTarget][curIneqcurve].length==3){dragObj={mode:targets[curTarget].mode,num:curIneqcurve,subnum:1};curIneqcurve=c}}}else if(a[0]==0||a[0]==.5)if(curLine==c){targets[curTarget].el.style.cursor=g;dragObj={mode:targets[curTarget].mode,num:a[1],subnum:a[2]};oldpointpos=lines[curTarget][a[1]][a[2]];if(a[2]==lines[curTarget][a[1]].length-1&&targets[curTarget].mode==0)curLine=a[1];else if(a[2]==0&&targets[curTarget].mode==0){curLine=a[1];lines[curTarget][curLine].reverse();dragObj.subnum=lines[curTarget][curLine].length-1}}else if(a[1]==curLine&&a[2]==lines[curTarget][a[1]].length-1){lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1);curLine=c}else{targets[curTarget].el.style.cursor=f+imasroot+j;lines[curTarget][curLine].push([b.x,b.y])}else if(a[0]==1){targets[curTarget].el.style.cursor=g;dragObj={mode:1,num:a[1]}}else if(a[0]==2){targets[curTarget].el.style.cursor=g;dragObj={mode:2,num:a[1]}}else if(a[0]>=5&&a[0]<10){targets[curTarget].el.style.cursor=g;dragObj={mode:a[0],num:a[1],subnum:a[2]};oldpointpos=tplines[curTarget][a[1]][a[2]]}else if(a[0]>=10&&a[0]<11){targets[curTarget].el.style.cursor=g;dragObj={mode:a[0],num:a[1],subnum:a[2]};oldpointpos=ineqlines[curTarget][a[1]][a[2]]}drawTarget()}else{if(curLine!=c){lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1);targets[curTarget].el.style.cursor=f+imasroot+h}if(curTPcurve!=c){tplines[curTarget][curTPcurve].length<2&&tplines[curTarget].splice(curTPcurve,1);targets[curTarget].el.style.cursor=f+imasroot+h}if(curIneqcurve!=c){ineqlines[curTarget][curIneqcurve].length<3&&ineqlines[curTarget].splice(curIneqcurve,1);targets[curTarget].el.style.cursor=f+imasroot+h}curLine=c;curTPcurve=c;curIneqcurve=c;dragObj=c;drawTarget();curTarget=c}}}function findnearpoint(a,d){if(hasTouch){var e=Math.max(15*window.innerWidth/screen.width,15);e*=e}else var e=25;if(drawstyle[a]==0){if(targets[a].mode==0||targets[a].mode==.5)for(var b=0;b<lines[a].length;b++)for(var c=lines[a][b].length-1;c>=0;c--){var f=Math.pow(lines[a][b][c][0]-d.x,2)+Math.pow(lines[a][b][c][1]-d.y,2);if(f<e)return[targets[a].mode,b,c]}else if(targets[a].mode==1){for(var b=0;b<dots[a].length;b++)if(Math.pow(dots[a][b][0]-d.x,2)+Math.pow(dots[a][b][1]-d.y,2)<e)return[1,b]}else if(targets[a].mode==2){for(var b=0;b<odots[a].length;b++)if(Math.pow(odots[a][b][0]-d.x,2)+Math.pow(odots[a][b][1]-d.y,2)<e)return[2,b]}else if(targets[a].mode>=5&&targets[a].mode<10)for(var b=0;b<tplines[a].length;b++){if(tptypes[a][b]!=targets[a].mode)continue;for(var c=tplines[a][b].length-1;c>=0;c--){var f=Math.pow(tplines[a][b][c][0]-d.x,2)+Math.pow(tplines[a][b][c][1]-d.y,2);if(f<e)return[tptypes[a][b],b,c]}}else if(targets[a].mode>=10&&targets[a].mode<11)for(var b=0;b<ineqlines[a].length;b++)for(var c=ineqlines[a][b].length-1;c>=0;c--){var f=Math.pow(ineqlines[a][b][c][0]-d.x,2)+Math.pow(ineqlines[a][b][c][1]-d.y,2);if(f<e)return[ineqtypes[a][b],b,c]}}else if(targets[a].mode==1){for(var b=0;b<dots[a].length;b++)if(Math.pow(dots[a][b][0]-d.x,2)+Math.pow(dots[a][b][1]-d.y,2)<e)return[1,b]}else if(targets[a].mode==2){for(var b=0;b<odots[a].length;b++)if(Math.pow(odots[a][b][0]-d.x,2)+Math.pow(odots[a][b][1]-d.y,2)<e)return[2,b]}else if(targets[a].mode>=5&&targets[a].mode<10)for(var b=0;b<tplines[a].length;b++)for(var c=tplines[a][b].length-1;c>=0;c--){if(tptypes[a][b]!=targets[a].mode)continue;var f=Math.pow(tplines[a][b][c][0]-d.x,2)+Math.pow(tplines[a][b][c][1]-d.y,2);if(f<e)return[tptypes[a][b],b,c]}else if(targets[a].mode>=10&&targets[a].mode<11)for(var b=0;b<ineqlines[a].length;b++)for(var c=ineqlines[a][b].length-1;c>=0;c--){var f=Math.pow(ineqlines[a][b][c][0]-d.x,2)+Math.pow(ineqlines[a][b][c][1]-d.y,2);if(f<e)return[ineqtypes[a][b],b,c]}return null}var lastdrawmouseup=null;function drawMouseUp(e){var a=null,c=mouseCoords(e);mouseisdown=false;if(curTarget!=a){var d=getPosition(targets[curTarget].el),b={x:c.x-d.x,y:c.y-d.y};if(lastdrawmouseup!=a&&c.x==lastdrawmouseup.x&&c.y==lastdrawmouseup.y)if(curLine!=a&&dragObj==a){lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1);curLine=a;dragObj=a;drawTarget()}if(curLine!=a&&dragObj==a)if(targets[curTarget].mode==.5&&lines[curTarget][curLine].length>1){curLine=a;dragobj=a;drawTarget()}if(curTPcurve!=a&&tplines[curTarget][curTPcurve].length==1)if(didMultiTouch){tplines[curTarget].splice(curTPcurve,1);curTPcurve=a;drawTarget()}else if(findnearpoint(curTarget,b)==a){tplines[curTarget][curTPcurve].push([b.x,b.y]);curTPcurve=a;drawTarget()}if(curIneqcurve!=a&&ineqlines[curTarget][curIneqcurve].length==1)if(didMultiTouch){ineqlines[curTarget].splice(curIneqcurve,1);curIneqcurve=a;drawTarget()}else if(findnearpoint(curTarget,b)==a){ineqlines[curTarget][curIneqcurve].push([b.x,b.y]);drawTarget()}if(curLine==a&&curTPcurve==a)targets[curTarget].el.style.cursor="move";else targets[curTarget].el.style.cursor="url("+imasroot+"/img/pen.cur), default";e.preventDefault()}lastdrawmouseup=c;if(curTarget!=a&&dragObj!=a){var d=getPosition(targets[curTarget].el);if(b.x>-1&&b.x<targets[curTarget].width&&b.y>-1&&b.y<targets[curTarget].height)dragObj=a;else{if(drawlocky[curTarget]==1)b.y=targets[curTarget].imgheight/2;if(dragObj.mode==1)dots[curTarget].splice(dragObj.num,1);else if(dragObj.mode==2)odots[curTarget].splice(dragObj.num,1);else if(dragObj.mode==.5)lines[curTarget].splice(dragObj.num,1);else if(dragObj.mode==0)lines[curTarget][dragObj.num][dragObj.subnum]=oldpointpos;else if(dragObj.mode>=5&&dragObj.mode<10){tplines[curTarget].splice(dragObj.num,1);curTPcurve=a}else if(dragObj.mode>=10&&dragObj.mode<11){ineqlines[curTarget].splice(dragObj.num,1);curIneqcurve=a}dragObj=a;drawTarget()}}didMultiTouch=false}function drawMouseMove(h){var g="move",j="/img/pen.cur), default",b=null,c=b,d=mouseCoords(h);if(curTarget==b)for(i in targets){var e=getPosition(targets[i].el);if(e.x<d.x&&e.x+targets[i].width>d.x&&e.y<d.y&&e.y+targets[i].height>d.y){c=i;break}}if(c!=b){var e=getPosition(targets[c].el),a={x:d.x-e.x,y:d.y-e.y};if(drawlocky[c]==1)a.y=targets[c].imgheight/2;if(a.x>-1&&a.x<targets[c].width&&a.y>-1&&a.y<targets[c].height)if(dragObj==b)if(curLine==b){var k=findnearpoint(c,a);if(k==b)targets[c].el.style.cursor="url("+imasroot+j;else targets[c].el.style.cursor=g}}if(curTarget!=b){if(hasTouch&&h.touches.length>1){didMultiTouch=true;return true}else h.preventDefault();var e=getPosition(targets[curTarget].el),a={x:d.x-e.x,y:d.y-e.y};if(drawlocky[curTarget]==1)a.y=targets[curTarget].imgheight/2;if(a.x>-1&&a.x<targets[curTarget].width&&a.y>-1&&a.y<targets[curTarget].height){if(dragObj==b)if(curLine!=b)if(mouseisdown&&targets[curTarget].mode==0){var f=lines[curTarget][curLine].length-1,l=Math.pow(lines[curTarget][curLine][f][0]-a.x,2)+Math.pow(lines[curTarget][curLine][f][1]-a.y,2);if(l>25){lines[curTarget][curLine].push([a.x,a.y]);drawTarget()}else drawTarget(a.x,a.y)}else if(mouseisdown&&targets[curTarget].mode==.5){var f=lines[curTarget][curLine].length-1;if(f==0){var l=Math.pow(lines[curTarget][curLine][f][0]-a.x,2)+Math.pow(lines[curTarget][curLine][f][1]-a.y,2);if(l>25){lines[curTarget][curLine].push([a.x,a.y]);drawTarget()}else drawTarget(a.x,a.y)}else{lines[curTarget][curLine][f]=[a.x,a.y];drawTarget()}}else drawTarget(a.x,a.y);else if(curTPcurve!=b)if(mouseisdown)drawTarget();else drawTarget(a.x,a.y);else if(curIneqcurve!=b)if(mouseisdown)drawTarget();else drawTarget(a.x,a.y);else{var k=findnearpoint(curTarget,a);if(k==b)targets[curTarget].el.style.cursor="url("+imasroot+j;else targets[curTarget].el.style.cursor=g}else{targets[curTarget].el.style.cursor=g;if(dragObj.mode==0||dragObj.mode==.5)lines[curTarget][dragObj.num][dragObj.subnum]=[a.x,a.y];else if(dragObj.mode==1)dots[curTarget][dragObj.num]=[a.x,a.y];else if(dragObj.mode==2)odots[curTarget][dragObj.num]=[a.x,a.y];else if(dragObj.mode>=5&&dragObj.mode<10)tplines[curTarget][dragObj.num][dragObj.subnum]=[a.x,a.y];else if(dragObj.mode>=10&&dragObj.mode<11)ineqlines[curTarget][dragObj.num][dragObj.subnum]=[a.x,a.y];drawTarget()}return false}}}function mouseCoords(a){a=a||window.event;if(hasTouch){var d=a.changedTouches[0]||a.touches[0];return{x:d.pageX,y:d.pageY}}if(a.pageX||a.pageY)return{x:a.pageX,y:a.pageY};var b=document.documentElement,c=document.body;if(b&&(b.scrollTop||b.scrollLeft))var e=b.scrollLeft,f=b.scrollTop;else if(c)var e=c.scrollLeft,f=c.scrollTop;else var e=0,f=0;return{x:a.clientX+e,y:a.clientY+f}}function getMouseOffset(c,d){var b=getPosition(c),a=mouseCoords(d);return{x:a.x-b.x,y:a.y-b.y}}function getPosition(a){var b=0,c=0;if(a.getBoundingClientRect){var d=a.getBoundingClientRect(),f=Math.max(document.documentElement.scrollTop,document.body.scrollTop),e=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);return{x:d.left+e,y:d.top+f}}while(a.offsetParent){b+=a.offsetLeft;c+=a.offsetTop;a=a.offsetParent}b+=a.offsetLeft;c+=a.offsetTop;return{x:b,y:c}}function initCanvases(c){hasTouch="ontouchstart"in document.documentElement;if(hasTouch){document.addEventListener("touchstart",drawMouseDown);document.addEventListener("touchmove",drawMouseMove);document.addEventListener("touchend",drawMouseUp)}else{document.onmousedown=drawMouseDown;document.onmouseup=drawMouseUp;document.onmousemove=drawMouseMove}for(var a in canvases)if(typeof c=="undefined"||c==a){if(drawla[a]!=null&&drawla[a].length>2){lines[canvases[a][0]]=drawla[a][0];dots[canvases[a][0]]=drawla[a][1];odots[canvases[a][0]]=drawla[a][2];if(drawla[a].length>3&&drawla[a][3].length>0){tptypes[canvases[a][0]]=[];tplines[canvases[a][0]]=[];for(var b=0;b<drawla[a][3].length;b++){tptypes[canvases[a][0]][b]=drawla[a][3][b][0];tplines[canvases[a][0]][b]=[drawla[a][3][b].slice(1,3),drawla[a][3][b].slice(3)]}}if(drawla[a].length>4&&drawla[a][4].length>0){ineqtypes[canvases[a][0]]=[];ineqlines[canvases[a][0]]=[];for(var b=0;b<drawla[a][4].length;b++){ineqtypes[canvases[a][0]][b]=drawla[a][4][b][0];ineqlines[canvases[a][0]][b]=[drawla[a][4][b].slice(1,3),drawla[a][4][b].slice(3,5),drawla[a][4][b].slice(5)]}}}addTarget(canvases[a][0],"canvas"+canvases[a][0],imasroot+"/filter/graph/imgs/"+canvases[a][1],"qn"+canvases[a][0],canvases[a][2],canvases[a][3],canvases[a][4],canvases[a][5],canvases[a][6],canvases[a][7],canvases[a][8],canvases[a][9],canvases[a][10],canvases[a][11])}}if(typeof initstack!="undefined")initstack.push(initCanvases);else if(typeof window.addEventListener!="undefined")window.addEventListener("load",initCanvases,false);else if(typeof document.addEventListener!="undefined")document.addEventListener("load",initCanvases,false);else if(typeof window.attachEvent!="undefined")window.attachEvent("onload",initCanvases);else if(typeof window.onload=="function"){var existing=onload;window.onload=function(){existing();initCanvases()}}else window.onload=initCanvases;
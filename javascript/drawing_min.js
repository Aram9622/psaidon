/* 
   Canvas-based function drawing script
   (c) David Lippman, part of www.imathas.com
   GNU 2 Licensed - see license in IMathAS distribution
   */
function clearcanvas(n){lines[n].length=0,dots[n].length=0,odots[n].length=0,tplines[n].length=0,tptypes[n].length=0,ineqlines[n].length=0,ineqtypes[n].length=0,curTarget=n,drawTarget(),curTarget=null,curLine=null,dragObj=null}function addTarget(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y){var p=document.getElementById(t),w;p.style.userSelect="none",p.style.webkitUserSelect="none",p.style.MozUserSelect="none",w=getPosition(p),targets[n]={el:p,left:w.x,top:w.y,width:p.offsetWidth,height:p.offsetHeight,xmin:u,xmax:f,ymin:e,ymax:o,imgborder:s,imgwidth:h,imgheight:c,mode:l,dotline:a},typeof y=="string"&&y.indexOf(":")!=-1?(y=y.split(":"),targets[n].snaptogridx=1*y[0],targets[n].snaptogridy=1*y[1]):(targets[n].snaptogridx=y,targets[n].snaptogridy=y),targets[n].pixperx=(h-2*s)/(f-u),targets[n].pixpery=e==o?1:(c-2*s)/(o-e),targetOuts[n]=document.getElementById(r),lines[n]==null&&(lines[n]=[]),dots[n]==null&&(dots[n]=[]),odots[n]==null&&(odots[n]=[]),tplines[n]==null&&(tplines[n]=[]),tptypes[n]==null&&(tptypes[n]=[]),ineqlines[n]==null&&(ineqlines[n]=[]),ineqtypes[n]==null&&(ineqtypes[n]=[]),drawstyle[n]=l>=5?1:0,drawlocky[n]=v,imgs[n]=new Image,imgs[n].onload=function(){var t=curTarget;curTarget=n,drawTarget(),curTarget=t},imgs[n].src=i}function settool(n,t,i){for(var f=document.getElementById("drawtools"+t),u=f.getElementsByTagName("span"),r=0;r<u.length;r++)u[r].className="";for(u=f.getElementsByTagName("img"),r=0;r<u.length;r++)u[r].className="";n.className="sel",setDrawMode(t,i)}function setDrawMode(n,t){targets[n].mode=t}function setDotLine(n,t){targets[n].dotline=t}function drawTarget(n,t){var r,ft,h,ut,it,b,st,o,y,p,f,u,k,c,a,w,l,v,s,nt,e,i;try{r=targets[curTarget].el.getContext("2d")}catch(kt){nocanvaswarning||(nocanvaswarning=!0,alert("Your browser does not support drawing answer entry.  Please try again using Internet Explorer 6+ (Windows), FireFox 1.5+ (Win/Mac), Safari 1.3+ (Mac), Opera 9+ (Win/Mac), or Camino (Mac)"))}for(r.fillStyle="rgb(0,0,255)",r.lineWidth=2,r.strokeStyle="rgb(0,0,255)",r.clearRect(0,0,targets[curTarget].imgwidth,targets[curTarget].imgheight),r.drawImage(imgs[curTarget],0,0),r.beginPath(),i=0;i<ineqlines[curTarget].length;i++){ft=i%3,r.strokeStyle=ineqcolors[ft],r.fillStyle=ineqcolors[ft];var o=null,u=null,d=null,f=null,et=null;if(ineqlines[curTarget][i].length==3?(u=ineqlines[curTarget][i][1][0],f=ineqlines[curTarget][i][1][1],d=ineqlines[curTarget][i][2][0],et=ineqlines[curTarget][i][2][1]):ineqlines[curTarget][i].length==2?(u=ineqlines[curTarget][i][1][0],f=ineqlines[curTarget][i][1][1],d=n,et=t):curIneqcurve==i&&n!=null&&ineqlines[curTarget][i].length==1&&(u=n,f=t),d!=null){if(r.save(),r.fillStyle=ineqacolors[ft],r.beginPath(),u!=ineqlines[curTarget][i][0][0]&&(o=(f-ineqlines[curTarget][i][0][1])/(u-ineqlines[curTarget][i][0][0])),Math.abs(u-ineqlines[curTarget][i][0][0])<1||Math.abs(o)>100)r.moveTo(ineqlines[curTarget][i][0][0],0),r.lineTo(ineqlines[curTarget][i][0][0],targets[curTarget].imgheight),d>u?(r.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),r.lineTo(targets[curTarget].imgwidth,0),r.closePath()):(r.lineTo(0,targets[curTarget].imgheight),r.lineTo(0,0),r.closePath());else{var lt=o*(d-u)+f,y=ineqlines[curTarget][i][0][1]-o*ineqlines[curTarget][i][0][0],p=ineqlines[curTarget][i][0][1]+o*(targets[curTarget].imgwidth-ineqlines[curTarget][i][0][0]);r.moveTo(0,y),r.lineTo(targets[curTarget].imgwidth,p),et>lt?(r.lineTo(targets[curTarget].imgwidth,targets[curTarget].imgheight),r.lineTo(0,targets[curTarget].imgheight),r.closePath()):(r.lineTo(targets[curTarget].imgwidth,0),r.lineTo(0,0),r.closePath())}r.fill(),r.restore()}for(r.beginPath(),u!=null&&(u!=ineqlines[curTarget][i][0][0]&&(o=(f-ineqlines[curTarget][i][0][1])/(u-ineqlines[curTarget][i][0][0])),Math.abs(u-ineqlines[curTarget][i][0][0])<1||Math.abs(o)>100?ineqtypes[curTarget][i]==10.2?dragObj!=null&&dragObj.mode>=10&&dragObj.mode<11&&dragObj.num==i&&dragObj.subnum==0?(r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],ineqlines[curTarget][i][1][0],targets[curTarget].imgheight),r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],ineqlines[curTarget][i][1][0],0)):(r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],ineqlines[curTarget][i][0][0],targets[curTarget].imgheight),r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],ineqlines[curTarget][i][0][0],0)):(r.moveTo(ineqlines[curTarget][i][0][0],0),r.lineTo(ineqlines[curTarget][i][0][0],targets[curTarget].imgheight),r.stroke()):(y=ineqlines[curTarget][i][0][1]-o*ineqlines[curTarget][i][0][0],p=ineqlines[curTarget][i][0][1]+o*(targets[curTarget].imgwidth-ineqlines[curTarget][i][0][0]),ineqtypes[curTarget][i]==10.2?dragObj!=null&&dragObj.mode>=10&&dragObj.mode<11&&dragObj.num==i&&dragObj.subnum==0?(r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],targets[curTarget].imgwidth,p),r.dashedLine(ineqlines[curTarget][i][1][0],ineqlines[curTarget][i][1][1],0,y)):(r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],targets[curTarget].imgwidth,p),r.dashedLine(ineqlines[curTarget][i][0][0],ineqlines[curTarget][i][0][1],0,y)):(r.moveTo(0,y),r.lineTo(targets[curTarget].imgwidth,p),r.stroke()))),r.beginPath(),e=0;e<ineqlines[curTarget][i].length;e++)e==2?(r.arc(ineqlines[curTarget][i][e][0],ineqlines[curTarget][i][e][1],4,0,Math.PI*2,!0),r.fill()):r.fillRect(ineqlines[curTarget][i][e][0]-3,ineqlines[curTarget][i][e][1]-3,6,6);ineqlines[curTarget][i].length==1&&u!=null&&r.fillRect(u-3,f-3,6,6),r.beginPath()}for(r.fillStyle="rgb(0,0,255)",r.lineWidth=drawlocky[curTarget]==1?4:2,r.strokeStyle="rgb(0,0,255)",i=0;i<tplines[curTarget].length;i++){if(tptypes[curTarget][i]>=5&&tptypes[curTarget][i]<6){var o=null,u=null,f=null,h,g;if(tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=null&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=null)if(tptypes[curTarget][i]==5.3||tptypes[curTarget][i]==5.4)r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),r.lineTo(u,f),tptypes[curTarget][i]==5.4&&(h=[u-tplines[curTarget][i][0][0],f-tplines[curTarget][i][0][1]],ut=Math.sqrt(h[0]*h[0]+h[1]*h[1]),ut>.0001&&(h=[h[0]/ut,h[1]/ut],g=[-h[1],h[0]],r.moveTo(u-15*h[0]-4*g[0],f-15*h[1]-5*g[1]),r.lineTo(u,f),r.moveTo(u-15*h[0]+4*g[0],f-15*h[1]+5*g[1]),r.lineTo(u,f)));else if(u!=tplines[curTarget][i][0][0]&&(o=(f-tplines[curTarget][i][0][1])/(u-tplines[curTarget][i][0][0])),Math.abs(u-tplines[curTarget][i][0][0])<1||Math.abs(o)>100)tptypes[curTarget][i]==5.2?(r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),f>tplines[curTarget][i][0][1]?r.lineTo(tplines[curTarget][i][0][0],targets[curTarget].imgheight):r.lineTo(tplines[curTarget][i][0][0],0)):(r.moveTo(tplines[curTarget][i][0][0],0),r.lineTo(tplines[curTarget][i][0][0],targets[curTarget].imgheight));else{var y=tplines[curTarget][i][0][1]-o*tplines[curTarget][i][0][0],p=tplines[curTarget][i][0][1]+o*(targets[curTarget].imgwidth-tplines[curTarget][i][0][0]),y=tplines[curTarget][i][0][1]-o*tplines[curTarget][i][0][0],p=tplines[curTarget][i][0][1]+o*(targets[curTarget].imgwidth-tplines[curTarget][i][0][0]);tptypes[curTarget][i]==5.2?(r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),u>tplines[curTarget][i][0][0]?r.lineTo(targets[curTarget].imgwidth,p):r.lineTo(0,y)):(r.moveTo(0,y),r.lineTo(targets[curTarget].imgwidth,p))}}else if(tptypes[curTarget][i]==6){if(f=null,u=null,tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=null&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=null&&u!=tplines[curTarget][i][0][0])if(f==tplines[curTarget][i][0][1])r.moveTo(0,f),r.lineTo(targets[curTarget].imgwidth,f);else{if(b=(f-tplines[curTarget][i][0][1])/((u-tplines[curTarget][i][0][0])*(u-tplines[curTarget][i][0][0])),f>tplines[curTarget][i][0][1])var tt=Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][i][0][1])/b)+tplines[curTarget][i][0][0],ct=-1*Math.sqrt((targets[curTarget].imgheight-tplines[curTarget][i][0][1])/b)+tplines[curTarget][i][0][0],at=tplines[curTarget][i][0][1]-(targets[curTarget].imgheight-tplines[curTarget][i][0][1]),rt=targets[curTarget].imgheight;else var tt=Math.sqrt((0-tplines[curTarget][i][0][1])/b)+tplines[curTarget][i][0][0],ct=-1*Math.sqrt((0-tplines[curTarget][i][0][1])/b)+tplines[curTarget][i][0][0],at=2*tplines[curTarget][i][0][1],rt=0;var ot=tt+2/3*(tplines[curTarget][i][0][0]-tt),ht=rt+2/3*(at-rt),wt=ot+(ct-tt)/3,bt=ht;r.moveTo(tt,rt),r.bezierCurveTo(ot,ht,wt,bt,ct,rt)}}else if(tptypes[curTarget][i]==6.5){if(f=null,u=null,tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=null&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=null&&u!=tplines[curTarget][i][0][0])if(f==tplines[curTarget][i][0][1])r.moveTo(tplines[curTarget][i][0][0],f),u>tplines[curTarget][i][0][0]?r.lineTo(targets[curTarget].imgwidth,f):r.lineTo(0,f);else{it=u<tplines[curTarget][i][0][0]?-1:1,b=(f-tplines[curTarget][i][0][1])/Math.sqrt(it*(u-tplines[curTarget][i][0][0])),r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),c=tplines[curTarget][i][0][0],k=tplines[curTarget][i][0][1];do c+=it*3,r.lineTo(c,b*Math.sqrt(it*(c-tplines[curTarget][i][0][0]))+tplines[curTarget][i][0][1]);while(c>0&&c<targets[curTarget].imgwidth&&k>0&&k<targets[curTarget].imgheight)}}else if(tptypes[curTarget][i]==7)tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=null&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=null&&(u!=tplines[curTarget][i][0][0]||f!=tplines[curTarget][i][0][1])&&(st=Math.sqrt((u-tplines[curTarget][i][0][0])*(u-tplines[curTarget][i][0][0])+(f-tplines[curTarget][i][0][1])*(f-tplines[curTarget][i][0][1])),r.arc(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1],st,0,2*Math.PI,!0));else if(tptypes[curTarget][i]==8){var o=null,u=null,f=null;tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=null&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=null&&(u!=tplines[curTarget][i][0][0]&&(o=(f-tplines[curTarget][i][0][1])/(u-tplines[curTarget][i][0][0]),u<tplines[curTarget][i][0][0]&&(o*=-1)),Math.abs(u-tplines[curTarget][i][0][0])<1||Math.abs(o)>100?(r.moveTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),f>tplines[curTarget][i][0][1]?r.lineTo(tplines[curTarget][i][0][0],targets[curTarget].imgheight):r.lineTo(tplines[curTarget][i][0][0],0)):(y=tplines[curTarget][i][0][1]+o*tplines[curTarget][i][0][0],p=tplines[curTarget][i][0][1]+o*(targets[curTarget].imgwidth-tplines[curTarget][i][0][0]),r.moveTo(0,y),r.lineTo(tplines[curTarget][i][0][0],tplines[curTarget][i][0][1]),r.lineTo(targets[curTarget].imgwidth,p)))}else if((tptypes[curTarget][i]==9||tptypes[curTarget][i]==9.1)&&(f=null,u=null,tplines[curTarget][i].length==2?(u=tplines[curTarget][i][1][0],f=tplines[curTarget][i][1][1]):curTPcurve==i&&n!=null&&tplines[curTarget][i].length==1&&(u=n,f=t),u!=null&&u!=tplines[curTarget][i][0][0]))if(f==tplines[curTarget][i][0][1])r.moveTo(0,f),r.lineTo(targets[curTarget].imgwidth,f);else{if(tptypes[curTarget][i]==9)var yt=Math.abs(f-tplines[curTarget][i][0][1])/-2,vt=(f+tplines[curTarget][i][0][1])/2,b=Math.PI/Math.abs(u-tplines[curTarget][i][0][0]),pt=f<tplines[curTarget][i][0][1]?u:tplines[curTarget][i][0][0];else if(tptypes[curTarget][i]==9.1)var yt=-1*Math.abs(f-tplines[curTarget][i][0][1]),vt=tplines[curTarget][i][0][1],b=.5*Math.PI/Math.abs(u-tplines[curTarget][i][0][0]),pt=f<tplines[curTarget][i][0][1]?u:u+2*Math.abs(u-tplines[curTarget][i][0][0]);for(k=0,c=0;c<targets[curTarget].imgwidth+4;c+=3)k=yt*Math.cos(b*(c-pt))+vt,c==0?r.moveTo(c,k):r.lineTo(c,k)}for(r.stroke(),e=0;e<tplines[curTarget][i].length;e++)r.fillRect(tplines[curTarget][i][e][0]-3,tplines[curTarget][i][e][1]-3,6,6);tplines[curTarget][i].length==1&&n!=null&&curTPcurve==i&&r.fillRect(n-3,t-3,6,6),r.beginPath()}for(i=0;i<lines[curTarget].length;i++){for(e=0;e<lines[curTarget][i].length;e++)e==0?(r.moveTo(lines[curTarget][i][e][0],lines[curTarget][i][e][1]),a=lines[curTarget][i][e][0],w=lines[curTarget][i][e][1]):(r.lineTo(lines[curTarget][i][e][0],lines[curTarget][i][e][1]),l=lines[curTarget][i][e][0],v=lines[curTarget][i][e][1]);i==curLine&&n!=null&&(r.lineTo(n,t),l=n,v=t),s=targets[curTarget].imgwidth*.02,drawlocky[curTarget]==1&&l>targets[curTarget].imgwidth*.98?(r.moveTo(l,v),r.lineTo(l-s,v+s),r.moveTo(l,v),r.lineTo(l-s,v-s)):drawlocky[curTarget]==1&&a>targets[curTarget].imgwidth*.98&&(r.moveTo(a,w),r.lineTo(a-s,w+s),r.moveTo(a,w),r.lineTo(a-s,w-s)),drawlocky[curTarget]==1&&l<targets[curTarget].imgwidth*.02?(r.moveTo(l,v),r.lineTo(l+s,v+s),r.moveTo(l,v),r.lineTo(l+s,v-s)):drawlocky[curTarget]==1&&a<targets[curTarget].imgwidth*.02&&(r.moveTo(a,w),r.lineTo(a+s,w+s),r.moveTo(a,w),r.lineTo(a+s,w-s))}for(r.stroke(),r.beginPath(),i=0;i<dots[curTarget].length;i++)r.moveTo(dots[curTarget][i][0]+5,dots[curTarget][i][1]),r.arc(dots[curTarget][i][0],dots[curTarget][i][1],5,0,Math.PI*2,!0);if(r.fill(),targets[curTarget].dotline>0){for(r.beginPath(),i=0;i<lines[curTarget].length;i++)for(e=0;e<lines[curTarget][i].length;e++)(e==0||Math.pow(lines[curTarget][i][e][0]-lines[curTarget][i][e-1][0],2)+Math.pow(lines[curTarget][i][e][1]-lines[curTarget][i][e-1][1],2)>25)&&(r.moveTo(lines[curTarget][i][e][0]+5,lines[curTarget][i][e][1]),r.arc(lines[curTarget][i][e][0],lines[curTarget][i][e][1],5,0,Math.PI*2,!0));if(r.fill(),targets[curTarget].dotline>1)for(i=0;i<lines[curTarget].length;i++)if((nt=lines[curTarget][i].length-1,!(nt<1))&&Math.pow(lines[curTarget][i][nt][0]-lines[curTarget][i][0][0],2)+Math.pow(lines[curTarget][i][nt][1]-lines[curTarget][i][0][1],2)<25){for(r.beginPath(),r.moveTo(lines[curTarget][i][0][0],lines[curTarget][i][0][1]),e=1;e<lines[curTarget][i].length;e++)r.lineTo(lines[curTarget][i][e][0],lines[curTarget][i][e][1]);r.closePath(),r.fillStyle="rgba(0,0,255,.5)",r.fill(),r.fillStyle="rgb(0,0,255)"}}for(r.fillStyle="rgb(255,255,255)",r.beginPath(),i=0;i<odots[curTarget].length;i++)r.moveTo(odots[curTarget][i][0]+5,odots[curTarget][i][1]),r.arc(odots[curTarget][i][0],odots[curTarget][i][1],4,0,Math.PI*2,!0);for(r.fill(),r.lineWidth=2,r.beginPath(),i=0;i<odots[curTarget].length;i++)r.moveTo(odots[curTarget][i][0]+5,odots[curTarget][i][1]),r.arc(odots[curTarget][i][0],odots[curTarget][i][1],4,0,Math.PI*2,!0);r.stroke(),encodeDraw()}function encodeDraw(){for(var t="",i,n=0;n<lines[curTarget].length;n++)for(n!=0&&(t+=";"),i=0;i<lines[curTarget][n].length;i++)i!=0&&(t+=","),t+="("+lines[curTarget][n][i][0]+","+lines[curTarget][n][i][1]+")";for(t+=";;",n=0;n<dots[curTarget].length;n++)n!=0&&(t+=","),t+="("+dots[curTarget][n][0]+","+dots[curTarget][n][1]+")";for(t+=";;",n=0;n<odots[curTarget].length;n++)n!=0&&(t+=","),t+="("+odots[curTarget][n][0]+","+odots[curTarget][n][1]+")";for(t+=";;",n=0;n<tplines[curTarget].length;n++)n!=0&&(t+=","),tplines[curTarget][n].length>1&&(t+="("+tptypes[curTarget][n]+","+tplines[curTarget][n][0][0]+","+tplines[curTarget][n][0][1]+","+tplines[curTarget][n][1][0]+","+tplines[curTarget][n][1][1]+")");for(t+=";;",n=0;n<ineqlines[curTarget].length;n++)n!=0&&(t+=","),ineqlines[curTarget][n].length>2&&(t+="("+ineqtypes[curTarget][n]+","+ineqlines[curTarget][n][0][0]+","+ineqlines[curTarget][n][0][1]+","+ineqlines[curTarget][n][1][0]+","+ineqlines[curTarget][n][1][1]+","+ineqlines[curTarget][n][2][0]+","+ineqlines[curTarget][n][2][1]+")");targetOuts[curTarget].value=t}function drawMouseDown(n){var f,u,r,t;if(hasTouch&&n.touches.length>1)return!0;if(f=mouseCoords(n),curTarget==null)for(i in targets)if(u=getPosition(targets[i].el),u.x<f.x&&u.x+targets[i].width>f.x&&u.y<f.y&&u.y+targets[i].height>f.y){curTarget=i;break}curTarget!=null&&(navigator.userAgent.match(/Android/i)&&n.preventDefault(),mouseisdown=!0,u=getPosition(targets[curTarget].el),r={x:f.x-u.x,y:f.y-u.y},r.x>-1&&r.x<targets[curTarget].width&&r.y>-1&&r.y<targets[curTarget].height?(targets[curTarget].snaptogridx>0&&(r=snaptogrid(r,curTarget)),drawlocky[curTarget]==1&&(r.y=targets[curTarget].imgheight/2),t=findnearpoint(curTarget,r),t==null?(targets[curTarget].el.style.cursor="url("+imasroot+"/img/pendown.cur), default",targets[curTarget].mode==1?(dots[curTarget].push([r.x,r.y]),dragObj={mode:1,num:dots[curTarget].length-1}):targets[curTarget].mode==2?(odots[curTarget].push([r.x,r.y]),dragObj={mode:2,num:odots[curTarget].length-1}):targets[curTarget].mode==0?curLine==null?(lines[curTarget].push([[r.x,r.y]]),curLine=lines[curTarget].length-1):lines[curTarget][curLine].push([r.x,r.y]):targets[curTarget].mode==.5?curLine==null?(lines[curTarget].push([[r.x,r.y]]),curLine=lines[curTarget].length-1):(lines[curTarget][curLine].push([r.x,r.y]),curLine=null,dragObj=null):targets[curTarget].mode>=5&&targets[curTarget].mode<10?curTPcurve==null?(tplines[curTarget].push([[r.x,r.y]]),curTPcurve=tplines[curTarget].length-1,tptypes[curTarget][curTPcurve]=targets[curTarget].mode,mouseisdown=!1):(tplines[curTarget][curTPcurve].push([r.x,r.y]),tplines[curTarget][curTPcurve].length==2&&(dragObj={mode:targets[curTarget].mode,num:curTPcurve,subnum:1},curTPcurve=null)):targets[curTarget].mode>=10&&targets[curTarget].mode<11&&(curIneqcurve==null?(ineqlines[curTarget].push([[r.x,r.y]]),curIneqcurve=ineqlines[curTarget].length-1,ineqtypes[curTarget][curIneqcurve]=targets[curTarget].mode,mouseisdown=!1):(ineqlines[curTarget][curIneqcurve].push([r.x,r.y]),ineqlines[curTarget][curIneqcurve].length==3&&(dragObj={mode:targets[curTarget].mode,num:curIneqcurve,subnum:1},curIneqcurve=null)))):t[0]==0||t[0]==.5?curLine==null?(targets[curTarget].el.style.cursor="move",dragObj={mode:targets[curTarget].mode,num:t[1],subnum:t[2]},oldpointpos=lines[curTarget][t[1]][t[2]],t[2]==lines[curTarget][t[1]].length-1&&targets[curTarget].mode==0?curLine=t[1]:t[2]==0&&targets[curTarget].mode==0&&(curLine=t[1],lines[curTarget][curLine].reverse(),dragObj.subnum=lines[curTarget][curLine].length-1)):t[1]==curLine&&t[2]==lines[curTarget][t[1]].length-1?(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),curLine=null):targets[curTarget].dotline>1&&t[1]==curLine&&t[2]==0?(lines[curTarget][curLine].push(lines[curTarget][curLine][0]),curLine=null):(targets[curTarget].el.style.cursor="url("+imasroot+"/img/pendown.cur), default",lines[curTarget][curLine].push([r.x,r.y])):t[0]==1?(targets[curTarget].el.style.cursor="move",dragObj={mode:1,num:t[1]}):t[0]==2?(targets[curTarget].el.style.cursor="move",dragObj={mode:2,num:t[1]}):t[0]>=5&&t[0]<10?(targets[curTarget].el.style.cursor="move",dragObj={mode:t[0],num:t[1],subnum:t[2]},oldpointpos=tplines[curTarget][t[1]][t[2]]):t[0]>=10&&t[0]<11&&(targets[curTarget].el.style.cursor="move",dragObj={mode:t[0],num:t[1],subnum:t[2]},oldpointpos=ineqlines[curTarget][t[1]][t[2]]),drawTarget()):(curLine!=null&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),targets[curTarget].el.style.cursor="url("+imasroot+"/img/pen.cur), default"),curTPcurve!=null&&(tplines[curTarget][curTPcurve].length<2&&tplines[curTarget].splice(curTPcurve,1),targets[curTarget].el.style.cursor="url("+imasroot+"/img/pen.cur), default"),curIneqcurve!=null&&(ineqlines[curTarget][curIneqcurve].length<3&&ineqlines[curTarget].splice(curIneqcurve,1),targets[curTarget].el.style.cursor="url("+imasroot+"/img/pen.cur), default"),curLine=null,curTPcurve=null,curIneqcurve=null,dragObj=null,drawTarget(),curTarget=null))}function findnearpoint(n,t){var u,i,r,f;if(hasTouch?(u=Math.max(15*window.innerWidth/screen.width,15),u*=u):u=25,drawstyle[n]==0){if(targets[n].mode==0||targets[n].mode==.5){for(i=0;i<lines[n].length;i++)for(r=lines[n][i].length-1;r>=0;r--)if(f=Math.pow(lines[n][i][r][0]-t.x,2)+Math.pow(lines[n][i][r][1]-t.y,2),f<u)return[targets[n].mode,i,r]}else if(targets[n].mode==1){for(i=0;i<dots[n].length;i++)if(Math.pow(dots[n][i][0]-t.x,2)+Math.pow(dots[n][i][1]-t.y,2)<u)return[1,i]}else if(targets[n].mode==2){for(i=0;i<odots[n].length;i++)if(Math.pow(odots[n][i][0]-t.x,2)+Math.pow(odots[n][i][1]-t.y,2)<u)return[2,i]}else if(targets[n].mode>=5&&targets[n].mode<10){for(i=0;i<tplines[n].length;i++)if(tptypes[n][i]==targets[n].mode)for(r=tplines[n][i].length-1;r>=0;r--)if(f=Math.pow(tplines[n][i][r][0]-t.x,2)+Math.pow(tplines[n][i][r][1]-t.y,2),f<u)return[tptypes[n][i],i,r]}else if(targets[n].mode>=10&&targets[n].mode<11)for(i=0;i<ineqlines[n].length;i++)for(r=ineqlines[n][i].length-1;r>=0;r--)if(f=Math.pow(ineqlines[n][i][r][0]-t.x,2)+Math.pow(ineqlines[n][i][r][1]-t.y,2),f<u)return[ineqtypes[n][i],i,r]}else if(targets[n].mode==1){for(i=0;i<dots[n].length;i++)if(Math.pow(dots[n][i][0]-t.x,2)+Math.pow(dots[n][i][1]-t.y,2)<u)return[1,i]}else if(targets[n].mode==2){for(i=0;i<odots[n].length;i++)if(Math.pow(odots[n][i][0]-t.x,2)+Math.pow(odots[n][i][1]-t.y,2)<u)return[2,i]}else if(targets[n].mode>=5&&targets[n].mode<10){for(i=0;i<tplines[n].length;i++)for(r=tplines[n][i].length-1;r>=0;r--)if(tptypes[n][i]==targets[n].mode&&(f=Math.pow(tplines[n][i][r][0]-t.x,2)+Math.pow(tplines[n][i][r][1]-t.y,2),f<u))return[tptypes[n][i],i,r]}else if(targets[n].mode>=10&&targets[n].mode<11)for(i=0;i<ineqlines[n].length;i++)for(r=ineqlines[n][i].length-1;r>=0;r--)if(f=Math.pow(ineqlines[n][i][r][0]-t.x,2)+Math.pow(ineqlines[n][i][r][1]-t.y,2),f<u)return[ineqtypes[n][i],i,r];return null}function drawMouseUp(n){var i=mouseCoords(n),t,r;mouseisdown=!1,curTarget!=null&&(r=getPosition(targets[curTarget].el),t={x:i.x-r.x,y:i.y-r.y},targets[curTarget].snaptogridx>0&&(t=snaptogrid(t,curTarget)),lastdrawmouseup!=null&&i.x==lastdrawmouseup.x&&i.y==lastdrawmouseup.y&&curLine!=null&&dragObj==null&&(lines[curTarget][curLine].length<2&&lines[curTarget].splice(curLine,1),curLine=null,dragObj=null,drawTarget()),curLine!=null&&dragObj==null&&targets[curTarget].mode==.5&&lines[curTarget][curLine].length>1&&(curLine=null,dragobj=null,drawTarget()),curTPcurve!=null&&tplines[curTarget][curTPcurve].length==1&&(didMultiTouch?(tplines[curTarget].splice(curTPcurve,1),curTPcurve=null,drawTarget()):findnearpoint(curTarget,t)==null&&(tplines[curTarget][curTPcurve].push([t.x,t.y]),curTPcurve=null,drawTarget())),curIneqcurve!=null&&ineqlines[curTarget][curIneqcurve].length==1&&(didMultiTouch?(ineqlines[curTarget].splice(curIneqcurve,1),curIneqcurve=null,drawTarget()):findnearpoint(curTarget,t)==null&&(ineqlines[curTarget][curIneqcurve].push([t.x,t.y]),drawTarget())),targets[curTarget].el.style.cursor=curLine==null&&curTPcurve==null?"move":"url("+imasroot+"/img/pen.cur), default",typeof n!="undefined"&&n.preventDefault()),lastdrawmouseup=i,curTarget!=null&&dragObj!=null&&(r=getPosition(targets[curTarget].el),t.x>-1&&t.x<targets[curTarget].width&&t.y>-1&&t.y<targets[curTarget].height?(dragObj.mode==0&&targets[curTarget].dotline>1&&(dragObj.subnum==0||dragObj.subnum==lines[curTarget][dragObj.num].length-1)&&Math.pow(lines[curTarget][dragObj.num][0][0]-lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][0],2)+Math.pow(lines[curTarget][dragObj.num][0][1]-lines[curTarget][dragObj.num][lines[curTarget][dragObj.num].length-1][1],2)<25&&(curLine=null),dragObj=null):(drawlocky[curTarget]==1&&(t.y=targets[curTarget].imgheight/2),dragObj.mode==1?dots[curTarget].splice(dragObj.num,1):dragObj.mode==2?odots[curTarget].splice(dragObj.num,1):dragObj.mode==.5?lines[curTarget].splice(dragObj.num,1):dragObj.mode==0?lines[curTarget][dragObj.num][dragObj.subnum]=oldpointpos:dragObj.mode>=5&&dragObj.mode<10?(tplines[curTarget].splice(dragObj.num,1),curTPcurve=null):dragObj.mode>=10&&dragObj.mode<11&&(ineqlines[curTarget].splice(dragObj.num,1),curIneqcurve=null),dragObj=null,drawTarget())),didMultiTouch=!1}function drawMouseMove(n){var r=null,e=mouseCoords(n),u,t,f,o,s;if(curTarget==null)for(i in targets)if(u=getPosition(targets[i].el),u.x<e.x&&u.x+targets[i].width>e.x&&u.y<e.y&&u.y+targets[i].height>e.y){r=i;break}if(r!=null&&(u=getPosition(targets[r].el),t={x:e.x-u.x,y:e.y-u.y},targets[r].snaptogridx>0&&(t=snaptogrid(t,r)),drawlocky[r]==1&&(t.y=targets[r].imgheight/2),t.x>-1&&t.x<targets[r].width&&t.y>-1&&t.y<targets[r].height&&dragObj==null&&curLine==null&&(s=findnearpoint(r,t),targets[r].el.style.cursor=s==null?"url("+imasroot+"/img/pen.cur), default":"move")),curTarget!=null){if(hasTouch&&n.touches.length>1)return didMultiTouch=!0,!0;if(typeof n!="undefined"&&n.preventDefault(),u=getPosition(targets[curTarget].el),t={x:e.x-u.x,y:e.y-u.y},targets[curTarget].snaptogridx>0&&(t=snaptogrid(t,curTarget)),drawlocky[curTarget]==1&&(t.y=targets[curTarget].imgheight/2),t.x>-1&&t.x<targets[curTarget].width&&t.y>-1&&t.y<targets[curTarget].height)return dragObj==null?curLine!=null?mouseisdown&&targets[curTarget].mode==0?(f=lines[curTarget][curLine].length-1,o=Math.pow(lines[curTarget][curLine][f][0]-t.x,2)+Math.pow(lines[curTarget][curLine][f][1]-t.y,2),o>25?(lines[curTarget][curLine].push([t.x,t.y]),drawTarget()):drawTarget(t.x,t.y)):mouseisdown&&targets[curTarget].mode==.5?(f=lines[curTarget][curLine].length-1,f==0?(o=Math.pow(lines[curTarget][curLine][f][0]-t.x,2)+Math.pow(lines[curTarget][curLine][f][1]-t.y,2),o>25?(lines[curTarget][curLine].push([t.x,t.y]),drawTarget()):drawTarget(t.x,t.y)):(lines[curTarget][curLine][f]=[t.x,t.y],drawTarget())):drawTarget(t.x,t.y):curTPcurve!=null?mouseisdown?drawTarget():drawTarget(t.x,t.y):curIneqcurve!=null?mouseisdown?drawTarget():drawTarget(t.x,t.y):(s=findnearpoint(curTarget,t),targets[curTarget].el.style.cursor=s==null?"url("+imasroot+"/img/pen.cur), default":"move"):(targets[curTarget].el.style.cursor="move",dragObj.mode==0||dragObj.mode==.5?lines[curTarget][dragObj.num][dragObj.subnum]=[t.x,t.y]:dragObj.mode==1?dots[curTarget][dragObj.num]=[t.x,t.y]:dragObj.mode==2?odots[curTarget][dragObj.num]=[t.x,t.y]:dragObj.mode>=5&&dragObj.mode<10?tplines[curTarget][dragObj.num][dragObj.subnum]=[t.x,t.y]:dragObj.mode>=10&&dragObj.mode<11&&(ineqlines[curTarget][dragObj.num][dragObj.subnum]=[t.x,t.y]),drawTarget()),!1}}function mouseCoords(n){var f,t,u,i,r;return(n=n||window.event,hasTouch)?(f=n.changedTouches[0]||n.touches[0],{x:f.pageX,y:f.pageY}):n.pageX||n.pageY?{x:n.pageX,y:n.pageY}:(t=document.documentElement,u=document.body,t&&(t.scrollTop||t.scrollLeft)?(i=t.scrollLeft,r=t.scrollTop):u?(i=u.scrollLeft,r=u.scrollTop):(i=0,r=0),{x:n.clientX+i,y:n.clientY+r})}function snaptogrid(n,t){var r=n.x-targets[t].imgborder+targets[t].xmin*targets[t].pixperx,i=n.y-targets[t].imgborder-targets[t].ymax*targets[t].pixpery;return r=Math.round(Math.round(r/(targets[t].pixperx*targets[t].snaptogridx))*targets[t].pixperx*targets[t].snaptogridx+targets[t].imgborder-targets[t].xmin*targets[t].pixperx),i=Math.round(Math.round(i/(targets[t].pixpery*targets[t].snaptogridy))*targets[t].pixpery*targets[t].snaptogridy+targets[t].imgborder+targets[t].ymax*targets[t].pixpery),{x:r,y:i}}function getMouseOffset(n,t){var r=getPosition(n),i=mouseCoords(t);return{x:i.x-r.x,y:i.y-r.y}}function getPosition(n){var i=0,t=0;if(n.getBoundingClientRect){var r=n.getBoundingClientRect(),f=Math.max(document.documentElement.scrollTop,document.body.scrollTop),u=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);return{x:r.left+u,y:r.top+f}}while(n.offsetParent)i+=n.offsetLeft,t+=n.offsetTop,n=n.offsetParent;return i+=n.offsetLeft,t+=n.offsetTop,{x:i,y:t}}function initCanvases(n){var t,i;hasTouch="ontouchstart"in document.documentElement,hasTouch?(document.addEventListener("touchstart",drawMouseDown),document.addEventListener("touchmove",drawMouseMove),document.addEventListener("touchend",drawMouseUp)):(document.onmousedown=drawMouseDown,document.onmouseup=drawMouseUp,document.onmousemove=drawMouseMove);try{CanvasRenderingContext2D.prototype.dashedLine=function(n,t,i,r,u){var e;u==undefined&&(u=10),this.beginPath(),this.moveTo(n,t);var o=i-n,s=r-t,f=Math.sqrt(o*o+s*s)/u,h=o/f,c=s/f;for(f=Math.round(f),e=0;e++<f&&t>0&&t<targets[curTarget].imgheight;)n+=h,t+=c,this[e%2==0?"moveTo":"lineTo"](n,t);this[e%2==0?"moveTo":"lineTo"](i,r),this.stroke(),this.closePath()}}catch(r){}for(t in canvases)if(typeof n=="undefined"||n==t){if(drawla[t]!=null&&drawla[t].length>2){if(lines[canvases[t][0]]=drawla[t][0],dots[canvases[t][0]]=drawla[t][1],odots[canvases[t][0]]=drawla[t][2],drawla[t].length>3&&drawla[t][3].length>0)for(tptypes[canvases[t][0]]=[],tplines[canvases[t][0]]=[],i=0;i<drawla[t][3].length;i++)tptypes[canvases[t][0]][i]=drawla[t][3][i][0],tplines[canvases[t][0]][i]=[drawla[t][3][i].slice(1,3),drawla[t][3][i].slice(3)];if(drawla[t].length>4&&drawla[t][4].length>0)for(ineqtypes[canvases[t][0]]=[],ineqlines[canvases[t][0]]=[],i=0;i<drawla[t][4].length;i++)ineqtypes[canvases[t][0]][i]=drawla[t][4][i][0],ineqlines[canvases[t][0]][i]=[drawla[t][4][i].slice(1,3),drawla[t][4][i].slice(3,5),drawla[t][4][i].slice(5)]}addTarget(canvases[t][0],"canvas"+canvases[t][0],imasroot+"/filter/graph/imgs/"+canvases[t][1],"qn"+canvases[t][0],canvases[t][2],canvases[t][3],canvases[t][4],canvases[t][5],canvases[t][6],canvases[t][7],canvases[t][8],canvases[t][9],canvases[t][10],canvases[t][11],canvases[t][12])}}function slideronpageload(){for(var n,t,i=0;i<normslider.idnums.length;i++)t=normslider.idnums[i],initnormslider(t),n=document.getElementById("slid1"+t),hasTouch?(n.addEventListener("touchstart",onsliderstart),n.parentNode.addEventListener("touchend",onsliderstop),n=document.getElementById("slid2"+t),n.addEventListener("touchstart",onsliderstart),n.parentNode.addEventListener("touchend",onsliderstop)):(n.onmousedown=onsliderstart,n.parentNode.onmouseup=onsliderstop,n=document.getElementById("slid2"+t),n.onmousedown=onsliderstart,n.parentNode.onmouseup=onsliderstop)}function initnormslider(n){var r,u,i,t,f=document.getElementById("qn"+n).value;(t=f.match(/\(-oo,([\-\d\.]+)\)U\(([\-\d\.]+),oo\)/))?(r=3,u=t[1],i=t[2]):(t=f.match(/\(-oo,([\-\d\.]+)\)/))?(r=0,u=t[1],i=2.5):(t=f.match(/\(([\-\d\.]+),oo\)/))?(r=1,u=t[1],i=2.5):(t=f.match(/\(([\-\d\.]+),([\-\d\.]+)\)/))?(r=2,u=t[1],i=t[2]):(r=0,u=-1.5,i=2.5),document.getElementById("slid1"+n).style.left=u*60+250-6+"px",document.getElementById("slid2"+n).style.left=i*60+250-6+"px",document.getElementById("shaderegions"+n).selectedIndex=r,normslider.curslider.type=document.getElementById("shaderegions"+n).value,chgnormtype(n)}function onsliderstart(n){n=n||window.event,normslider.curslider.el=n.target,normslider.curslider.id=n.target.id.substring(5),normslider.curslider.type=document.getElementById("shaderegions"+normslider.curslider.id).value,normslider.curslider.outnode=document.getElementById(normslider.outputid),normslider.curslider.startpos=getMouseOffset(normslider.curslider.el,n),hasTouch?document.addEventListener("touchmove",onsliderchange):normslider.curslider.el.parentNode.onmousemove=onsliderchange,normslider.curslider.el.parentNode.style.cursor="pointer";var t=getPosition(normslider.curslider.el.parentNode);return n.preventDefault(),!1}function onsliderchange(n){var r=normslider.curslider.id,t,i;if(n=n||window.event,t=getMouseOffset(normslider.curslider.el.parentNode,n),!(t.x<5)&&!(t.x>normslider.curslider.el.parentNode.offsetWidth-5)&&!(t.y<5)&&!(t.y>normslider.curslider.el.parentNode.offsetHeight-5))return i=Math.round((t.x-normslider.curslider.startpos.x-10)/6)*6+10,normslider.curslider.el.style.left=i+"px",normupdatevalues(r),n.preventDefault(),!1}function onsliderstop(){normslider.curslider.el!==null&&(hasTouch?document.removeEventListener("touchmove",onsliderchange):normslider.curslider.el.parentNode.onmousemove=null,normslider.curslider.el.parentNode.style.cursor="",normslider.curslider.el=null)}function normupdatevalues(n){var t=parseInt(document.getElementById("slid1"+n).style.left)+6,u=parseInt(document.getElementById("slid2"+n).style.left)+6,s=Math.min(t,u),c=Math.max(t,u),f,e,o,r;normslider.curslider.type=="2O"?document.getElementById("normleft"+n).style.width=s+1+"px":normslider.curslider.type=="1L"?document.getElementById("normleft"+n).style.width=t+1+"px":normslider.curslider.type=="2B"&&(document.getElementById("normleft"+n).style.left=s+"px",document.getElementById("normleft"+n).style.width=c-s+1+"px"),normslider.curslider.type=="2O"?document.getElementById("normright"+n).style.width=500-c+"px":normslider.curslider.type=="1R"&&(document.getElementById("normright"+n).style.width=500-t+"px");var i=(-4+(t-10)/60).toFixed(1),h=(-4+(u-10)/60).toFixed(1),l=document.getElementById("slid1txt"+n);l.innerHTML=i,l.style.left=t-6+"px",f=document.getElementById("slid2txt"+n),f.innerHTML=h,f.style.left=u-6+"px",e=Math.min(i,h),o=Math.max(i,h),normslider.curslider.type=="2O"?r="(-oo,"+e+")U("+o+",oo)":normslider.curslider.type=="2B"?r="("+e+","+o+")":normslider.curslider.type=="1L"?r="(-oo,"+i+")":normslider.curslider.type=="1R"&&(r="("+i+",oo)"),document.getElementById("qn"+n).value=r}function chgnormtype(n){var t=document.getElementById("shaderegions"+n).value;normslider.curslider.type=t;var i=parseInt(document.getElementById("slid1"+n).style.left)+6,f=parseInt(document.getElementById("slid2"+n).style.left)+6,r=Math.min(i,f),u=Math.max(i,f);t=="1R"||t=="1L"?(document.getElementById("slid2"+n).style.display="none",document.getElementById("slid2txt"+n).style.display="none",t=="1R"?(document.getElementById("normleft"+n).style.display="none",document.getElementById("normright"+n).style.display="",document.getElementById("normright"+n).style.right="0px",document.getElementById("normright"+n).style.width=500-i+"px"):(document.getElementById("normright"+n).style.display="none",document.getElementById("normleft"+n).style.display="",document.getElementById("normleft"+n).style.left="0px",document.getElementById("normleft"+n).style.width=i+"px")):t=="2O"?(document.getElementById("slid2"+n).style.display="",document.getElementById("slid2txt"+n).style.display="",document.getElementById("normleft"+n).style.display="",document.getElementById("normright"+n).style.display="",document.getElementById("normright"+n).style.right="0px",document.getElementById("normleft"+n).style.left="0px",document.getElementById("normright"+n).style.width=500-u+"px",document.getElementById("normleft"+n).style.width=r+"px"):t=="2B"&&(document.getElementById("slid2"+n).style.display="",document.getElementById("slid2txt"+n).style.display="",document.getElementById("normleft"+n).style.display="",document.getElementById("normright"+n).style.display="none",document.getElementById("normleft"+n).style.left=r+"px",document.getElementById("normleft"+n).style.width=u-r+"px"),normupdatevalues(n)}var mouseisdown=!1,targets=[],imgs=[],targetOuts=[],lines=[],dots=[],odots=[],tplines=[],tptypes=[],ineqlines=[],ineqtypes=[],canvases=[],drawla=[],curLine=null,drawstyle=[],drawlocky=[],curTPcurve=null,curIneqcurve=null,ineqcolors=["rgb(0,0,255)","rgb(255,0,0)","rgb(0,255,0)"],ineqacolors=["rgba(0,0,255,.4)","rgba(255,0,0,.4)","rgba(0,255,0,.4)"],dragObj=null,oldpointpos=null,curTarget=null,nocanvaswarning=!1,hasTouch=!1,didMultiTouch=!1,lastdrawmouseup=null,existing,normslider;typeof initstack!="undefined"?initstack.push(initCanvases):typeof window.addEventListener!="undefined"?window.addEventListener("load",initCanvases,!1):typeof document.addEventListener!="undefined"?document.addEventListener("load",initCanvases,!1):typeof window.attachEvent!="undefined"?window.attachEvent("onload",initCanvases):typeof window.onload=="function"?(existing=onload,window.onload=function(){existing(),initCanvases()}):window.onload=initCanvases,normslider={idnums:[],curslider:{el:null,startpos:[0,0],outnode:null}},typeof initstack!="undefined"&&initstack.push(slideronpageload);